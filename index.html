<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>è‹±è¯­æåˆ†ç³»ç»Ÿ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- è…¾è®¯äº‘ CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f3f4ff;color:#1f2749}
  header{background:#6653ff;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  select,button{padding:10px 14px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:10px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  ul{list-style:none;padding:0}
  li{padding:10px;border:1px solid #e9ecef;margin:5px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center}
  li:hover{background:#f8f9fa}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:5px 15px;border-radius:4px;cursor:pointer}
  .delete-btn:hover{background:#c82333}
</style>
</head>
<body>
<header>
  <h1>è‹±è¯­æåˆ†ç³»ç»Ÿ</h1>
  <nav>
    <a href="index.html">å­¦ç”Ÿç«¯</a> | 
    <a href="dashboard.html">æ•™å¸ˆç«¯</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>ç³»ç»ŸçŠ¶æ€</h3>
    <div id="sdkStatus">æ£€æµ‹ä¸­...</div>
    <div id="authStatus" style="margin-top:10px"></div>
    <div id="dbStatus" style="margin-top:10px"></div>
  </div>
  
  <div class="status-box">
    <h3>é€‰æ‹©å­¦ç”Ÿ</h3>
    <select id="studentSelect" style="width:100%">
      <option value="" disabled selected>åŠ è½½ä¸­...</option>
    </select>
    <div style="margin-top:15px">
      <button onclick="loadStudents()">åˆ·æ–°åˆ—è¡¨</button>
      <button onclick="window.location.href='dashboard.html'">æ•™å¸ˆç®¡ç†</button>
    </div>
  </div>
  
  <div id="studentList" style="margin-top:20px"></div>
</main>

<script>
// å…¨å±€å˜é‡
let app = null;
let auth = null;
let db = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(initApp, 500);
});

// åˆå§‹åŒ–åº”ç”¨
function initApp() {
  const sdkStatus = document.getElementById('sdkStatus');
  const authStatus = document.getElementById('authStatus');
  const dbStatus = document.getElementById('dbStatus');
  
  // æ£€æŸ¥SDK
  if (typeof cloudbase === 'undefined') {
    sdkStatus.innerHTML = '<span class="error">âœ— SDKæœªåŠ è½½</span>';
    return;
  }
  
  sdkStatus.innerHTML = '<span class="success">âœ“ SDKå·²åŠ è½½</span>';
  
  try {
    // åˆå§‹åŒ–CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // è®¾ç½®è®¤è¯æŒä¹…åŒ–
    auth = app.auth({
      persistence: 'local'
    });
    
    // è·å–æ•°æ®åº“å¼•ç”¨
    db = app.database();
    
    sdkStatus.innerHTML += ' | <span class="success">âœ“ å·²åˆå§‹åŒ–</span>';
    
    // è¿›è¡Œè®¤è¯
    performAuth();
    
  } catch (error) {
    sdkStatus.innerHTML += ' | <span class="error">âœ— åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// æ‰§è¡Œè®¤è¯
async function performAuth() {
  const authStatus = document.getElementById('authStatus');
  
  try {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      authStatus.innerHTML = '<span class="info">æ­£åœ¨è¿›è¡ŒåŒ¿åç™»å½•...</span>';
      
      // è¿›è¡ŒåŒ¿åç™»å½•
      await auth.anonymousAuthProvider().signIn();
      
      authStatus.innerHTML = '<span class="success">âœ“ åŒ¿åç™»å½•æˆåŠŸ</span>';
    } else {
      authStatus.innerHTML = '<span class="success">âœ“ å·²ç™»å½•</span>';
    }
    
    // æµ‹è¯•æ•°æ®åº“è¿æ¥
    testDatabase();
    
  } catch (error) {
    authStatus.innerHTML = '<span class="error">âœ— è®¤è¯å¤±è´¥: ' + error.message + '</span>';
    console.error('è®¤è¯å¤±è´¥:', error);
    
    // å¦‚æœæ˜¯ ACCESS_TOKEN_DISABLED é”™è¯¯ï¼Œæä¾›è§£å†³æ–¹æ¡ˆ
    if (error.message && error.message.includes('ACCESS_TOKEN_DISABLED')) {
      authStatus.innerHTML += '<br><span class="warning">æç¤º: è¯·åœ¨è…¾è®¯äº‘æ§åˆ¶å°å¼€å¯åŒ¿åç™»å½•åŠŸèƒ½</span>';
    }
  }
}

// æµ‹è¯•æ•°æ®åº“
async function testDatabase() {
  const dbStatus = document.getElementById('dbStatus');
  
  try {
    // å°è¯•è¯»å–studentsé›†åˆ
    const res = await db.collection('students').limit(1).get();
    
    dbStatus.innerHTML = '<span class="success">âœ“ æ•°æ®åº“è¿æ¥æ­£å¸¸</span>';
    
    // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
    loadStudents();
    
  } catch (error) {
    dbStatus.innerHTML = '<span class="error">âœ— æ•°æ®åº“è¿æ¥å¤±è´¥: ' + error.message + '</span>';
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      dbStatus.innerHTML += '<br><span class="warning">æç¤º: è¯·è®¾ç½®æ•°æ®åº“æƒé™ä¸º"æ‰€æœ‰ç”¨æˆ·å¯è¯»"</span>';
    }
    
    console.error('æ•°æ®åº“æµ‹è¯•å¤±è´¥:', error);
  }
}

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨
async function loadStudents() {
  const select = document.getElementById('studentSelect');
  const list = document.getElementById('studentList');
  
  if (!db) {
    select.innerHTML = '<option value="" disabled selected>ç³»ç»Ÿæœªåˆå§‹åŒ–</option>';
    return;
  }
  
  select.innerHTML = '<option value="" disabled selected>åŠ è½½ä¸­...</option>';
  list.innerHTML = '';
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginState = await auth.getLoginState();
    if (!loginState) {
      await auth.anonymousAuthProvider().signIn();
    }
    
    // è¯»å–å­¦ç”Ÿæ•°æ®
    const res = await db.collection('students').get();
    
    if (!res.data || res.data.length === 0) {
      select.innerHTML = '<option value="" disabled selected>æš‚æ— å­¦ç”Ÿæ•°æ®</option>';
      list.innerHTML = '<div class="status-box"><span class="warning">æš‚æ— å­¦ç”Ÿï¼Œè¯·åœ¨æ•™å¸ˆç«¯æ·»åŠ </span></div>';
      return;
    }
    
    // å¡«å……ä¸‹æ‹‰åˆ—è¡¨
    select.innerHTML = '<option value="" disabled selected>è¯·é€‰æ‹©å­¦ç”Ÿ</option>';
    res.data.forEach(student => {
      const option = document.createElement('option');
      option.value = student._id;
      option.textContent = student.name;
      select.appendChild(option);
    });
    
    // æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
    const ul = document.createElement('ul');
    res.data.forEach(student => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>ğŸ“š ${student.name}</span>
        <button class="delete-btn" style="display:none">é€‰æ‹©</button>
      `;
      ul.appendChild(li);
    });
    list.appendChild(ul);
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    const successMsg = document.createElement('div');
    successMsg.className = 'status-box';
    successMsg.innerHTML = '<span class="success">âœ“ æˆåŠŸåŠ è½½ ' + res.data.length + ' ä¸ªå­¦ç”Ÿ</span>';
    list.insertBefore(successMsg, list.firstChild);
    
  } catch (error) {
    select.innerHTML = '<option value="" disabled selected>åŠ è½½å¤±è´¥</option>';
    list.innerHTML = '<div class="status-box"><span class="error">åŠ è½½å¤±è´¥: ' + error.message + '</span></div>';
    console.error('åŠ è½½å­¦ç”Ÿå¤±è´¥:', error);
  }
}
</script>

</body>
</html>