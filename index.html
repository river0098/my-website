<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>英语提分系统（匿名登录版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.6.0/cloudbase.full.js"></script>
<style>
  body{font-family:"Segoe UI",Arial,"Microsoft YaHei";margin:0;background:#f3f4ff;color:#1f2749}
  header{background:#6653ff;color:#fff;padding:20px;text-align:center}
  main{max-width:800px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  select,button{padding:10px 14px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  .cloud-status{font-size:14px;margin-left:10px}
  .cloud-status.offline{color:red}
</style>
</head>
<body>
<header>
  <h1>英语提分系统 <span class="cloud-status" id="cloudStatus">☁️ 正在连接…</span></h1>
</header>
<main>
  <h2>选择学生</h2>
  <select id="studentSelect"></select>
  <button id="reloadStudents">重新加载学生</button>
  <div id="studentLoadMsg"></div>
</main>

<script>
const CLOUD_ENV_ID = "cloud1-8gxc5t0wed3aa3e2"; // ⚠️ 替换为你的环境ID
let app, db;

try {
  app = cloudbase.init({ env: CLOUD_ENV_ID });
  db = app.database();
  document.getElementById('cloudStatus').textContent = '✅ 云端已初始化';
} catch (err) {
  console.error('❌ CloudBase 初始化失败:', err);
  const cs = document.getElementById('cloudStatus');
  cs.textContent = '❌ 云端未连接';
  cs.classList.add('offline');
}

// 设置持久化
app.auth({ persistence: "local" });

// 匿名登录函数
async function ensureAnonymousLogin() {
  try {
    const loginState = await app.auth().getLoginState();
    if (!loginState) {
      await app.auth().anonymousAuthProvider().signIn();
      console.log("✅ 匿名登录成功");
    } else {
      console.log("✅ 已有匿名登录态");
    }
  } catch (err) {
    console.error("❌ 匿名登录失败:", err);
    throw err;
  }
}

// 加载学生名单
async function loadStudents() {
  const select = document.getElementById('studentSelect');
  const msg = document.getElementById('studentLoadMsg');
  select.innerHTML = '<option value="" disabled selected>加载中…</option>';
  msg.textContent = '';
  try {
    const res = await db.collection("students").get();
    if (!res.data || res.data.length === 0) {
      select.innerHTML = '<option value="" disabled selected>暂无学生</option>';
      msg.textContent = '提示：请在 CloudBase → students 集合添加 {"name":"张三"}';
      return;
    }
    select.innerHTML = '<option value="" disabled selected>选择学生姓名</option>';
    res.data.forEach(item => {
      const option = document.createElement("option");
      option.value = item.name;
      option.textContent = item.name;
      select.appendChild(option);
    });
    console.log("✅ 学生名单已加载:", res.data.map(s => s.name));
  } catch (err) {
    console.error("❌ 加载学生失败:", err);
    select.innerHTML = '<option value="" disabled selected>加载失败</option>';
    msg.textContent = "错误：" + (err.message || err);
  }
}

// 页面加载时
window.addEventListener("DOMContentLoaded", async () => {
  try {
    await ensureAnonymousLogin();
    await loadStudents();
  } catch (e) {
    document.getElementById("studentLoadMsg").textContent = "登录失败: " + (e.message || e);
  }
});

// 重新加载按钮
document.getElementById("reloadStudents").addEventListener("click", async () => {
  try {
    await ensureAnonymousLogin();
    await loadStudents();
  } catch (e) {
    document.getElementById("studentLoadMsg").textContent = "登录失败: " + (e.message || e);
  }
});
</script>
</body>
</html>