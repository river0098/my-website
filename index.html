<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>英语提分系统（最终稳妥版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body{font-family:"Segoe UI",Arial,"Microsoft YaHei";margin:0;background:#f3f4ff;color:#1f2749}
  header{background:#6653ff;color:#fff;padding:20px;text-align:center}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  select,button{padding:10px 14px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  .cloud-status{font-size:14px;margin-left:10px}
  .cloud-status.offline{color:#e33}
  .hint{font-size:13px;color:#6d7691}
  .box{padding:16px;border:1px solid #eee;border-radius:10px}
  .sdk-log{margin-top:12px;font-size:12px;color:#6d7691;line-height:1.5;white-space:pre-line}
</style>
</head>
<body>
<header>
  <h1>英语提分系统 <span id="cloudStatus" class="cloud-status">☁️ 正在尝试加载 SDK…</span></h1>
  <div class="hint">若长时间不变，请刷新（Cmd+Shift+R）或检查本地网络策略</div>
</header>

<main class="box">
  <h2>选择学生</h2>
  <select id="studentSelect"></select>
  <button id="reloadStudents">重新加载学生</button>
  <div id="studentLoadMsg" class="hint"></div>
  <div id="sdkLog" class="sdk-log"></div>
</main>

<script>
(function bootstrapCloudBase(){
  const statusEl = document.getElementById('cloudStatus');
  const logEl = document.getElementById('sdkLog');
  const cdnSources = [
    { label: '腾讯官方 CDN', url: 'https://imgcache.qq.com/qcloud/cloudbase-js-sdk/2.10.0/cloudbase.full.js' },
    { label: 'jsDelivr',     url: 'https://cdn.jsdelivr.net/npm/@cloudbase/js-sdk@2.10.0/dist/cloudbase.full.min.js' },
    { label: 'unpkg',        url: 'https://unpkg.com/@cloudbase/js-sdk@2.10.0/dist/cloudbase.full.min.js' },
    { label: '本地内置版本', url: './vendor/cloudbase.full.min.js' }
  ];
  let tried = [];
  let loaded = false;

  function updateStatus(text, offline){
    statusEl.textContent = text;
    statusEl.classList.toggle('offline', !!offline);
  }

  function appendLog(message){
    tried.push(message);
    logEl.textContent = tried.join('\n');
  }

  function loadNext(index){
    if (loaded) return;
    if (index >= cdnSources.length){
      updateStatus('❌ 无法加载 CloudBase SDK', true);
      appendLog('全部 CDN 尝试失败，请检查网络或手动下载 vendor/cloudbase.full.min.js');
      console.error('所有 CDN 加载失败');
      return;
    }
    const { label, url } = cdnSources[index];
    updateStatus(`☁️ 加载 CloudBase SDK (${label})…`, false);
    appendLog(`尝试：${label} → ${url}`);
    const script = document.createElement('script');
    script.src = url;
    script.async = true;
    script.onload = () => {
      if (loaded) return;
      if (typeof window.cloudbase === 'undefined'){
        appendLog(`⚠️ ${label} 返回成功，但未检测到 window.cloudbase，对应资源可能被替换`);
        loadNext(index + 1);
        return;
      }
      loaded = true;
      appendLog(`✅ ${label} 加载成功`);
      updateStatus('✅ SDK 已加载，准备初始化');
      initializeApp();
    };
    script.onerror = () => {
      appendLog(`❌ ${label} 加载失败`);
      loadNext(index + 1);
    };
    document.head.appendChild(script);
  }

  async function initializeApp(){
    const CLOUD_ENV_ID = 'cloud1-8gxc5t0wed3aa3e2'; // ⚠️ 替换为你的环境 ID
    let app, db, auth;

    try {
      app  = cloudbase.init({ env: CLOUD_ENV_ID });
      auth = app.auth({ persistence: 'local' });
      db   = app.database();
      updateStatus('✅ 云端已初始化');
    } catch (e){
      updateStatus('❌ 云端初始化失败', true);
      appendLog(`初始化异常：${e && e.message ? e.message : e}`);
      console.error('CloudBase 初始化失败:', e);
      return;
    }

    async function ensureAnonymousLogin(){
      try {
        const loginState = await auth.getLoginState();
        if (!loginState){
          await auth.anonymousAuthProvider().signIn();
          appendLog('✅ 匿名登录成功');
        } else {
          appendLog('✅ 已存在匿名登录态');
        }
      } catch (err){
        document.getElementById('studentLoadMsg').textContent = '登录失败：' + (err.message || err);
        appendLog(`匿名登录失败：${err && err.message ? err.message : err}`);
        console.error('匿名登录失败:', err);
        throw err;
      }
    }

    async function loadStudents(){
      const select = document.getElementById('studentSelect');
      const msg = document.getElementById('studentLoadMsg');
      select.innerHTML = '<option value="" disabled selected>加载中…</option>';
      msg.textContent = '';
      try {
        const res = await db.collection('students').get();
        const list = res && res.data ? res.data : [];
        if (!list.length){
          select.innerHTML = '<option value="" disabled selected>暂无学生</option>';
          msg.textContent = '提示：请在 CloudBase → students 集合添加 {"name":"张三"}';
          appendLog('ℹ️ 数据库 students 集合为空');
          return;
        }
        list.sort((a, b) => (a.name || '').localeCompare(b.name || '', 'zh-Hans-CN'));
        select.innerHTML = '<option value="" disabled selected>选择学生姓名</option>';
        list.forEach(item => {
          if (!item || !item.name) return;
          const option = document.createElement('option');
          option.value = item.name;
          option.textContent = item.name;
          select.appendChild(option);
        });
        appendLog(`✅ 成功加载 ${list.length} 位学生`);
      } catch (err){
        select.innerHTML = '<option value="" disabled selected>加载失败</option>';
        msg.textContent = '错误：' + (err.message || err);
        appendLog(`❌ 加载学生失败：${err && err.message ? err.message : err}`);
        console.error('加载学生失败:', err);
      }
    }

    window.addEventListener('DOMContentLoaded', async () => {
      try {
        await ensureAnonymousLogin();
        await loadStudents();
      } catch (_) {}
    });

    document.getElementById('reloadStudents').addEventListener('click', async () => {
      try {
        await ensureAnonymousLogin();
        await loadStudents();
      } catch (_) {}
    });
  }

  loadNext(0);
})();
</script>

</body>
</html>
