<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>英语提分系统(SDK 2.0版)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 使用 CloudBase SDK 2.0 -->
<script src="https://cdn.jsdelivr.net/npm/@cloudbase/js-sdk@2.0.1/dist/index.umd.js"></script>
<style>
  body{font-family:"Segoe UI",Arial,"Microsoft YaHei";margin:0;background:#f3f4ff;color:#1f2749}
  header{background:#6653ff;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  select,button{padding:10px 14px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  .cloud-status{font-size:14px;margin-left:10px}
  .cloud-status.offline{color:#e33}
  .cloud-status.success{color:#0a0}
  .hint{font-size:13px;color:#6d7691;margin-top:10px}
  .box{padding:16px;border:1px solid #eee;border-radius:10px}
  .error-msg{background:#ffebee;border-left:4px solid #f44336;padding:15px;margin:10px 0;border-radius:5px}
  .success-msg{background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;margin:10px 0;border-radius:5px}
</style>
</head>
<body>
<header>
  <h1>英语提分系统 <span id="cloudStatus" class="cloud-status">正在初始化...</span></h1>
  <nav>
    <a href="index.html">学生端</a> | 
    <a href="dashboard.html">教师端</a>
  </nav>
</header>
<main class="box">
  <h2>选择学生</h2>
  <div id="messageDisplay"></div>
  <select id="studentSelect"></select>
  <button id="reloadStudents">重新加载学生</button>
  <div id="studentLoadMsg" class="hint"></div>
</main>

<script>
window.addEventListener('DOMContentLoaded', async () => {
  const cs = document.getElementById('cloudStatus');
  const messageDisplay = document.getElementById('messageDisplay');
  const studentSelect = document.getElementById('studentSelect');
  const msg = document.getElementById('studentLoadMsg');
  
  // 检查 SDK
  if (typeof window.cloudbase === 'undefined') {
    cs.textContent = 'SDK未加载';
    cs.classList.add('offline');
    messageDisplay.innerHTML = '<div class="error-msg">SDK 未加载,请检查网络连接</div>';
    return;
  }
  
  console.log('SDK版本:', window.cloudbase.version || '未知');
  cs.textContent = 'SDK已加载';
  
  const CLOUD_ENV_ID = "cloud1-8gxc5t0wed3aa3e2";
  let app, db, auth;
  
  try {
    // 使用新版SDK初始化方式
    app = window.cloudbase.init({
      env: CLOUD_ENV_ID
    });
    
    auth = app.auth({
      persistence: 'local'
    });
    
    db = app.database();
    
    cs.textContent = '云端已初始化';
    cs.classList.add('success');
    console.log('CloudBase初始化成功');
    
  } catch (e) {
    cs.textContent = '初始化失败';
    cs.classList.add('offline');
    messageDisplay.innerHTML = `<div class="error-msg">云端初始化失败: ${e.message}</div>`;
    console.error('初始化失败:', e);
    return;
  }

  async function ensureAnonymousLogin() {
    try {
      const loginState = await auth.getLoginState();
      if (!loginState) {
        console.log('开始匿名登录...');
        await auth.anonymousAuthProvider().signIn();
        console.log('匿名登录成功');
      } else {
        console.log('已有登录态');
      }
    } catch (err) {
      console.error('登录失败:', err);
      messageDisplay.innerHTML = `
        <div class="error-msg">
          <strong>登录失败</strong><br>
          ${err.message}<br><br>
          请确认已在腾讯云控制台开启"匿名登录"
        </div>
      `;
      throw err;
    }
  }

  async function loadStudents() {
    studentSelect.innerHTML = '<option value="" disabled selected>加载中...</option>';
    msg.textContent = '';
    messageDisplay.innerHTML = '';
    
    try {
      await ensureAnonymousLogin();
      
      console.log('开始读取students集合...');
      const res = await db.collection('students').get();
      console.log('数据读取成功:', res);
      
      const list = res && res.data ? res.data : [];
      
      if (!list.length) {
        studentSelect.innerHTML = '<option value="" disabled selected>暂无学生</option>';
        msg.textContent = '提示: 在 CloudBase → students 集合添加数据';
        messageDisplay.innerHTML = `
          <div class="error-msg">
            暂无学生数据<br>
            请在腾讯云控制台的 students 集合中添加数据,格式: {"name":"张三"}
          </div>
        `;
        return;
      }
      
      list.sort((a,b)=>(a.name||'').localeCompare(b.name||'','zh-Hans-CN'));
      studentSelect.innerHTML = '<option value="" disabled selected>选择学生姓名</option>';
      
      list.forEach(item=>{
        if(!item || !item.name) return;
        const opt = document.createElement('option');
        opt.value = item.name;
        opt.textContent = item.name;
        studentSelect.appendChild(opt);
      });
      
      messageDisplay.innerHTML = `<div class="success-msg">成功加载 ${list.length} 个学生</div>`;
      msg.textContent = `已加载 ${list.length} 个学生`;
      msg.style.color = '#0a0';
      console.log('学生列表已显示:', list.map(s=>s.name));
      
    } catch (err) {
      console.error('加载失败:', err);
      studentSelect.innerHTML = '<option value="" disabled selected>加载失败</option>';
      
      let errorMsg = err.message || err;
      let solution = '';
      
      if (err.code === 'DATABASE_PERMISSION_DENIED' || errorMsg.includes('permission')) {
        solution = `
          <strong>这是权限问题!</strong><br>
          解决方法:<br>
          1. 进入腾讯云 CloudBase 控制台<br>
          2. 数据库 → students 集合 → 权限设置<br>
          3. 选择"所有用户-读取全部数据,修改本人数据"
        `;
      } else if (err.code && err.code.includes('AUTH')) {
        solution = `
          <strong>这是认证问题!</strong><br>
          解决方法:<br>
          CloudBase 控制台 → 用户管理 → 登录授权 → 开启"匿名登录"
        `;
      }
      
      messageDisplay.innerHTML = `
        <div class="error-msg">
          <strong>数据加载失败</strong><br>
          错误: ${errorMsg}<br>
          错误代码: ${err.code || '无'}<br><br>
          ${solution}
        </div>
      `;
    }
  }

  // 初始加载
  try {
    await loadStudents();
  } catch (e) {
    console.error('初始加载失败:', e);
  }
  
  // 重新加载按钮
  document.getElementById('reloadStudents').addEventListener('click', async () => {
    try {
      await loadStudents();
    } catch (e) {
      console.error('重新加载失败:', e);
    }
  });
});
</script>
</body>
</html>