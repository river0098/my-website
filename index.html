<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>英语提分系统（最终稳妥版）</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- 1) 腾讯官方 CDN -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/2.9.0/cloudbase.full.js"></script>
<!-- 2) jsDelivr（npm 源）-->
<script src="https://cdn.jsdelivr.net/npm/@cloudbase/js-sdk@2.9.0/dist/cloudbase.full.min.js"></script>
<!-- 3) unpkg（npm 源备用）-->
<script src="https://unpkg.com/@cloudbase/js-sdk@2.9.0/dist/cloudbase.full.min.js"></script>

<style>
  body{font-family:"Segoe UI",Arial,"Microsoft YaHei";margin:0;background:#f3f4ff;color:#1f2749}
  header{background:#6653ff;color:#fff;padding:20px;text-align:center}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  select,button{padding:10px 14px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  .cloud-status{font-size:14px;margin-left:10px}
  .cloud-status.offline{color:#e33}
  .hint{font-size:13px;color:#6d7691}
  .box{padding:16px;border:1px solid #eee;border-radius:10px}
</style>
</head>
<body>
<header>
  <h1>英语提分系统 <span id="cloudStatus" class="cloud-status">☁️ 正在加载 SDK…</span></h1>
  <div class="hint">若长时间不变，请尝试刷新（Cmd+Shift+R）</div>
</header>

<main class="box">
  <h2>选择学生</h2>
  <select id="studentSelect"></select>
  <button id="reloadStudents">重新加载学生</button>
  <div id="studentLoadMsg" class="hint"></div>
</main>

<script>
(function ensureSdkLoaded(){
  const cs = document.getElementById('cloudStatus');
  if (typeof window.cloudbase === 'undefined') {
    cs.textContent = '❌ SDK 未加载（网络或 CDN 被拦截）';
    cs.classList.add('offline');
    console.error('CloudBase SDK 未加载成功：请检查三条 CDN 是否能在本机打开：',
      '1) https://imgcache.qq.com/qcloud/cloudbase-js-sdk/2.9.0/cloudbase.full.js',
      '2) https://cdn.jsdelivr.net/npm/@cloudbase/js-sdk@2.9.0/dist/cloudbase.full.min.js',
      '3) https://unpkg.com/@cloudbase/js-sdk@2.9.0/dist/cloudbase.full.min.js'
    );
    // 直接终止后续逻辑，避免 undefined 报错
    return;
  } else {
    cs.textContent = '✅ SDK 已加载，准备初始化';
  }

  const CLOUD_ENV_ID = "cloud1-8gxc5t0wed3aa3e2"; // ⚠️ 替换为你的环境ID
  let app, db, auth;

  try {
    app  = cloudbase.init({ env: CLOUD_ENV_ID });
    auth = app.auth({ persistence: "local" });
    db   = app.database();
    cs.textContent = '✅ 云端已初始化';
  } catch (e) {
    cs.textContent = '❌ 云端未连接';
    cs.classList.add('offline');
    console.error('CloudBase 初始化失败:', e);
    return;
  }

  async function ensureAnonymousLogin() {
    try {
      const loginState = await auth.getLoginState();
      if (!loginState) {
        await auth.anonymousAuthProvider().signIn();
        console.log('✅ 匿名登录成功');
      } else {
        console.log('✅ 已有匿名登录态');
      }
    } catch (err) {
      document.getElementById('studentLoadMsg').textContent = '登录失败：' + (err.message || err);
      console.error('❌ 匿名登录失败:', err);
      throw err;
    }
  }

  async function loadStudents() {
    const select = document.getElementById('studentSelect');
    const msg    = document.getElementById('studentLoadMsg');
    select.innerHTML = '<option value="" disabled selected>加载中…</option>';
    msg.textContent  = '';
    try {
      const res = await db.collection('students').get();
      const list = res && res.data ? res.data : [];
      if (!list.length) {
        select.innerHTML = '<option value="" disabled selected>暂无学生</option>';
        msg.textContent = '提示：在 CloudBase → students 集合添加 {"name":"张三"}';
        console.log('ℹ️ students 集合为空', res);
        return;
      }
      list.sort((a,b)=>(a.name||'').localeCompare(b.name||'','zh-Hans-CN'));
      select.innerHTML = '<option value="" disabled selected>选择学生姓名</option>';
      list.forEach(item=>{
        if(!item || !item.name) return;
        const opt = document.createElement('option');
        opt.value = item.name;
        opt.textContent = item.name;
        select.appendChild(opt);
      });
      console.log('✅ 学生名单已加载：', list.map(s=>s.name));
    } catch (err) {
      select.innerHTML = '<option value="" disabled selected>加载失败</option>';
      msg.textContent  = '错误：' + (err.message || err);
      console.error('❌ 加载学生失败:', err);
    }
  }

  // 页面加载：先登录，再加载
  window.addEventListener('DOMContentLoaded', async () => {
    try { await ensureAnonymousLogin(); await loadStudents(); } catch(e){}
  });

  // 重新加载按钮
  document.getElementById('reloadStudents').addEventListener('click', async () => {
    try { await ensureAnonymousLogin(); await loadStudents(); } catch(e){}
  });
})();
</script>

</body>
</html>