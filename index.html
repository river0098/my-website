<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>英语提分系统</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- 腾讯云 CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f3f4ff;color:#1f2749}
  header{background:#6653ff;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  select,button{padding:10px 14px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:15px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:10px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  ul{list-style:none;padding:0}
  li{padding:10px;border:1px solid #e9ecef;margin:5px 0;border-radius:5px;display:flex;justify-content:space-between;align-items:center}
  li:hover{background:#f8f9fa}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:5px 15px;border-radius:4px;cursor:pointer}
  .delete-btn:hover{background:#c82333}
</style>
</head>
<body>
<header>
  <h1>英语提分系统</h1>
  <nav>
    <a href="index.html">学生端</a> | 
    <a href="dashboard.html">教师端</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>系统状态</h3>
    <div id="sdkStatus">检测中...</div>
    <div id="authStatus" style="margin-top:10px"></div>
    <div id="dbStatus" style="margin-top:10px"></div>
  </div>
  
  <div class="status-box">
    <h3>选择学生</h3>
    <select id="studentSelect" style="width:100%">
      <option value="" disabled selected>加载中...</option>
    </select>
    <div style="margin-top:15px">
      <button onclick="loadStudents()">刷新列表</button>
      <button onclick="window.location.href='dashboard.html'">教师管理</button>
    </div>
  </div>
  
  <div id="studentList" style="margin-top:20px"></div>
</main>

<script>
// 全局变量
let app = null;
let auth = null;
let db = null;

// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(initApp, 500);
});

// 初始化应用
function initApp() {
  const sdkStatus = document.getElementById('sdkStatus');
  const authStatus = document.getElementById('authStatus');
  const dbStatus = document.getElementById('dbStatus');
  
  // 检查SDK
  if (typeof cloudbase === 'undefined') {
    sdkStatus.innerHTML = '<span class="error">✗ SDK未加载</span>';
    return;
  }
  
  sdkStatus.innerHTML = '<span class="success">✓ SDK已加载</span>';
  
  try {
    // 初始化CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // 设置认证持久化
    auth = app.auth({
      persistence: 'local'
    });
    
    // 获取数据库引用
    db = app.database();
    
    sdkStatus.innerHTML += ' | <span class="success">✓ 已初始化</span>';
    
    // 进行认证
    performAuth();
    
  } catch (error) {
    sdkStatus.innerHTML += ' | <span class="error">✗ 初始化失败: ' + error.message + '</span>';
    console.error('初始化失败:', error);
  }
}

// 执行认证
async function performAuth() {
  const authStatus = document.getElementById('authStatus');
  
  try {
    // 检查登录状态
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      authStatus.innerHTML = '<span class="info">正在进行匿名登录...</span>';
      
      // 进行匿名登录
      await auth.anonymousAuthProvider().signIn();
      
      authStatus.innerHTML = '<span class="success">✓ 匿名登录成功</span>';
    } else {
      authStatus.innerHTML = '<span class="success">✓ 已登录</span>';
    }
    
    // 测试数据库连接
    testDatabase();
    
  } catch (error) {
    authStatus.innerHTML = '<span class="error">✗ 认证失败: ' + error.message + '</span>';
    console.error('认证失败:', error);
    
    // 如果是 ACCESS_TOKEN_DISABLED 错误，提供解决方案
    if (error.message && error.message.includes('ACCESS_TOKEN_DISABLED')) {
      authStatus.innerHTML += '<br><span class="warning">提示: 请在腾讯云控制台开启匿名登录功能</span>';
    }
  }
}

// 测试数据库
async function testDatabase() {
  const dbStatus = document.getElementById('dbStatus');
  
  try {
    // 尝试读取students集合
    const res = await db.collection('students').limit(1).get();
    
    dbStatus.innerHTML = '<span class="success">✓ 数据库连接正常</span>';
    
    // 加载学生列表
    loadStudents();
    
  } catch (error) {
    dbStatus.innerHTML = '<span class="error">✗ 数据库连接失败: ' + error.message + '</span>';
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      dbStatus.innerHTML += '<br><span class="warning">提示: 请设置数据库权限为"所有用户可读"</span>';
    }
    
    console.error('数据库测试失败:', error);
  }
}

// 加载学生列表
async function loadStudents() {
  const select = document.getElementById('studentSelect');
  const list = document.getElementById('studentList');
  
  if (!db) {
    select.innerHTML = '<option value="" disabled selected>系统未初始化</option>';
    return;
  }
  
  select.innerHTML = '<option value="" disabled selected>加载中...</option>';
  list.innerHTML = '';
  
  try {
    // 确保已登录
    const loginState = await auth.getLoginState();
    if (!loginState) {
      await auth.anonymousAuthProvider().signIn();
    }
    
    // 读取学生数据
    const res = await db.collection('students').get();
    
    if (!res.data || res.data.length === 0) {
      select.innerHTML = '<option value="" disabled selected>暂无学生数据</option>';
      list.innerHTML = '<div class="status-box"><span class="warning">暂无学生，请在教师端添加</span></div>';
      return;
    }
    
    // 填充下拉列表
    select.innerHTML = '<option value="" disabled selected>请选择学生</option>';
    res.data.forEach(student => {
      const option = document.createElement('option');
      option.value = student._id;
      option.textContent = student.name;
      select.appendChild(option);
    });
    
    // 显示学生列表
    const ul = document.createElement('ul');
    res.data.forEach(student => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span>📚 ${student.name}</span>
        <button class="delete-btn" style="display:none">选择</button>
      `;
      ul.appendChild(li);
    });
    list.appendChild(ul);
    
    // 显示成功消息
    const successMsg = document.createElement('div');
    successMsg.className = 'status-box';
    successMsg.innerHTML = '<span class="success">✓ 成功加载 ' + res.data.length + ' 个学生</span>';
    list.insertBefore(successMsg, list.firstChild);
    
  } catch (error) {
    select.innerHTML = '<option value="" disabled selected>加载失败</option>';
    list.innerHTML = '<div class="status-box"><span class="error">加载失败: ' + error.message + '</span></div>';
    console.error('加载学生失败:', error);
  }
}
</script>

</body>
</html>