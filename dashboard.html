<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>教师端 Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- 腾讯云 CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f9faff;color:#1f2749}
  header{background:#333;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:10px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  input,button{padding:10px 14px;margin:5px;border-radius:6px;border:1px solid #ced4da;font-size:14px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  ul{list-style:none;padding:0;margin-top:20px}
  li{padding:12px;border:1px solid #e9ecef;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;background:#fff}
  li:hover{background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px}
  .delete-btn:hover{background:#c82333}
  .student-name{font-size:16px;color:#495057}
  .empty-state{text-align:center;padding:40px;color:#6c757d}
</style>
</head>
<body>
<header>
  <h1>教师端 Dashboard</h1>
  <nav>
    <a href="index.html">学生端</a> | 
    <a href="dashboard.html">教师端</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>系统状态</h3>
    <div id="statusMsg">正在初始化...</div>
  </div>
  
  <div class="status-box">
    <h3>学生管理</h3>
    <div style="display:flex;align-items:center">
      <input type="text" id="studentName" placeholder="输入学生姓名" style="flex:1">
      <button onclick="addStudent()">添加学生</button>
    </div>
  </div>
  
  <div id="listContainer">
    <h3>学生列表</h3>
    <ul id="studentList">
      <li class="empty-state">加载中...</li>
    </ul>
  </div>
</main>

<script>
// 全局变量
let app = null;
let auth = null;
let db = null;

// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(initApp, 500);
});

// 初始化应用
async function initApp() {
  const statusMsg = document.getElementById('statusMsg');
  
  // 检查SDK
  if (typeof cloudbase === 'undefined') {
    statusMsg.innerHTML = '<span class="error">✗ SDK 未加载，请检查网络连接</span>';
    return;
  }
  
  statusMsg.innerHTML = '<span class="success">✓ SDK 已加载</span>';
  
  try {
    // 初始化CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // 设置认证
    auth = app.auth({
      persistence: 'local'
    });
    
    // 获取数据库引用
    db = app.database();
    
    statusMsg.innerHTML = '<span class="success">✓ 云开发已初始化</span>';
    
    // 确保登录
    await ensureLogin();
    
    // 加载学生列表
    await loadStudents();
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 初始化失败: ' + error.message + '</span>';
    console.error('初始化失败:', error);
  }
}

// 确保登录
async function ensureLogin() {
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      statusMsg.innerHTML = '<span class="info">正在进行匿名登录...</span>';
      await auth.anonymousAuthProvider().signIn();
      statusMsg.innerHTML = '<span class="success">✓ 匿名登录成功</span>';
    } else {
      statusMsg.innerHTML = '<span class="success">✓ 已登录</span>';
    }
    
    return true;
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 登录失败: ' + error.message + '</span>';
    
    if (error.message && error.message.includes('ACCESS_TOKEN_DISABLED')) {
      statusMsg.innerHTML += '<br><span class="warning">请在腾讯云控制台开启匿名登录</span>';
    }
    
    console.error('登录失败:', error);
    return false;
  }
}

// 加载学生列表
async function loadStudents() {
  const list = document.getElementById('studentList');
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) return;
    
    // 读取学生数据
    const res = await db.collection('students').get();
    
    // 清空列表
    list.innerHTML = '';
    
    if (!res.data || res.data.length === 0) {
      list.innerHTML = '<li class="empty-state">暂无学生数据，请添加学生</li>';
      statusMsg.innerHTML = '<span class="warning">暂无学生数据</span>';
      return;
    }
    
    // 显示学生列表
    res.data.forEach(student => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="student-name">📚 ${student.name}</span>
        <button class="delete-btn" onclick="deleteStudent('${student._id}')">删除</button>
      `;
      list.appendChild(li);
    });
    
    statusMsg.innerHTML = '<span class="success">✓ 已加载 ' + res.data.length + ' 个学生</span>';
    
  } catch (error) {
    list.innerHTML = '<li class="empty-state">加载失败: ' + error.message + '</li>';
    statusMsg.innerHTML = '<span class="error">✗ 加载失败: ' + error.message + '</span>';
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      statusMsg.innerHTML += '<br><span class="warning">请设置数据库权限为"所有用户可读"</span>';
    }
    
    console.error('加载学生失败:', error);
  }
}

// 添加学生
window.addStudent = async function() {
  const nameInput = document.getElementById('studentName');
  const name = nameInput.value.trim();
  const statusMsg = document.getElementById('statusMsg');
  
  if (!name) {
    alert('请输入学生姓名');
    return;
  }
  
  if (!db) {
    alert('系统未初始化');
    return;
  }
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) return;
    
    statusMsg.innerHTML = '<span class="info">正在添加...</span>';
    
    // 添加到数据库
    await db.collection('students').add({
      name: name,
      createdAt: new Date().toISOString()
    });
    
    // 清空输入框
    nameInput.value = '';
    
    // 显示成功消息
    statusMsg.innerHTML = '<span class="success">✓ 已添加学生: ' + name + '</span>';
    
    // 重新加载列表
    await loadStudents();
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 添加失败: ' + error.message + '</span>';
    console.error('添加学生失败:', error);
  }
}

// 删除学生
window.deleteStudent = async function(id) {
  if (!confirm('确定要删除该学生吗？')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  
  if (!db) {
    alert('系统未初始化');
    return;
  }
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) return;
    
    statusMsg.innerHTML = '<span class="info">正在删除...</span>';
    
    // 从数据库删除
    await db.collection('students').doc(id).remove();
    
    statusMsg.innerHTML = '<span class="success">✓ 已删除学生</span>';
    
    // 重新加载列表
    await loadStudents();
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 删除失败: ' + error.message + '</span>';
    console.error('删除学生失败:', error);
  }
}
</script>

</body>
</html>