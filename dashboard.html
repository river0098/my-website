<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ•™å¸ˆç«¯ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- è…¾è®¯äº‘ CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f9faff;color:#1f2749}
  header{background:#333;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:10px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  input,button{padding:10px 14px;margin:5px;border-radius:6px;border:1px solid #ced4da;font-size:14px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  ul{list-style:none;padding:0;margin-top:20px}
  li{padding:12px;border:1px solid #e9ecef;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;background:#fff}
  li:hover{background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px}
  .delete-btn:hover{background:#c82333}
  .student-name{font-size:16px;color:#495057}
  .empty-state{text-align:center;padding:40px;color:#6c757d}
</style>
</head>
<body>
<header>
  <h1>æ•™å¸ˆç«¯ Dashboard</h1>
  <nav>
    <a href="index.html">å­¦ç”Ÿç«¯</a> | 
    <a href="dashboard.html">æ•™å¸ˆç«¯</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>ç³»ç»ŸçŠ¶æ€</h3>
    <div id="statusMsg">æ­£åœ¨åˆå§‹åŒ–...</div>
  </div>
  
  <div class="status-box">
    <h3>å­¦ç”Ÿç®¡ç†</h3>
    <div style="display:flex;align-items:center">
      <input type="text" id="studentName" placeholder="è¾“å…¥å­¦ç”Ÿå§“å" style="flex:1">
      <button onclick="addStudent()">æ·»åŠ å­¦ç”Ÿ</button>
    </div>
  </div>
  
  <div id="listContainer">
    <h3>å­¦ç”Ÿåˆ—è¡¨</h3>
    <ul id="studentList">
      <li class="empty-state">åŠ è½½ä¸­...</li>
    </ul>
  </div>
</main>

<script>
// å…¨å±€å˜é‡
let app = null;
let auth = null;
let db = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
  setTimeout(initApp, 500);
});

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
  const statusMsg = document.getElementById('statusMsg');
  
  // æ£€æŸ¥SDK
  if (typeof cloudbase === 'undefined') {
    statusMsg.innerHTML = '<span class="error">âœ— SDK æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</span>';
    return;
  }
  
  statusMsg.innerHTML = '<span class="success">âœ“ SDK å·²åŠ è½½</span>';
  
  try {
    // åˆå§‹åŒ–CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // è®¾ç½®è®¤è¯
    auth = app.auth({
      persistence: 'local'
    });
    
    // è·å–æ•°æ®åº“å¼•ç”¨
    db = app.database();
    
    statusMsg.innerHTML = '<span class="success">âœ“ äº‘å¼€å‘å·²åˆå§‹åŒ–</span>';
    
    // ç¡®ä¿ç™»å½•
    await ensureLogin();
    
    // åŠ è½½å­¦ç”Ÿåˆ—è¡¨
    await loadStudents();
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// ç¡®ä¿ç™»å½•
async function ensureLogin() {
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      statusMsg.innerHTML = '<span class="info">æ­£åœ¨è¿›è¡ŒåŒ¿åç™»å½•...</span>';
      await auth.anonymousAuthProvider().signIn();
      statusMsg.innerHTML = '<span class="success">âœ“ åŒ¿åç™»å½•æˆåŠŸ</span>';
    } else {
      statusMsg.innerHTML = '<span class="success">âœ“ å·²ç™»å½•</span>';
    }
    
    return true;
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— ç™»å½•å¤±è´¥: ' + error.message + '</span>';
    
    if (error.message && error.message.includes('ACCESS_TOKEN_DISABLED')) {
      statusMsg.innerHTML += '<br><span class="warning">è¯·åœ¨è…¾è®¯äº‘æ§åˆ¶å°å¼€å¯åŒ¿åç™»å½•</span>';
    }
    
    console.error('ç™»å½•å¤±è´¥:', error);
    return false;
  }
}

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨
async function loadStudents() {
  const list = document.getElementById('studentList');
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) return;
    
    // è¯»å–å­¦ç”Ÿæ•°æ®
    const res = await db.collection('students').get();
    
    // æ¸…ç©ºåˆ—è¡¨
    list.innerHTML = '';
    
    if (!res.data || res.data.length === 0) {
      list.innerHTML = '<li class="empty-state">æš‚æ— å­¦ç”Ÿæ•°æ®ï¼Œè¯·æ·»åŠ å­¦ç”Ÿ</li>';
      statusMsg.innerHTML = '<span class="warning">æš‚æ— å­¦ç”Ÿæ•°æ®</span>';
      return;
    }
    
    // æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
    res.data.forEach(student => {
      const li = document.createElement('li');
      li.innerHTML = `
        <span class="student-name">ğŸ“š ${student.name}</span>
        <button class="delete-btn" onclick="deleteStudent('${student._id}')">åˆ é™¤</button>
      `;
      list.appendChild(li);
    });
    
    statusMsg.innerHTML = '<span class="success">âœ“ å·²åŠ è½½ ' + res.data.length + ' ä¸ªå­¦ç”Ÿ</span>';
    
  } catch (error) {
    list.innerHTML = '<li class="empty-state">åŠ è½½å¤±è´¥: ' + error.message + '</li>';
    statusMsg.innerHTML = '<span class="error">âœ— åŠ è½½å¤±è´¥: ' + error.message + '</span>';
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      statusMsg.innerHTML += '<br><span class="warning">è¯·è®¾ç½®æ•°æ®åº“æƒé™ä¸º"æ‰€æœ‰ç”¨æˆ·å¯è¯»"</span>';
    }
    
    console.error('åŠ è½½å­¦ç”Ÿå¤±è´¥:', error);
  }
}

// æ·»åŠ å­¦ç”Ÿ
window.addStudent = async function() {
  const nameInput = document.getElementById('studentName');
  const name = nameInput.value.trim();
  const statusMsg = document.getElementById('statusMsg');
  
  if (!name) {
    alert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');
    return;
  }
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) return;
    
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨æ·»åŠ ...</span>';
    
    // æ·»åŠ åˆ°æ•°æ®åº“
    await db.collection('students').add({
      name: name,
      createdAt: new Date().toISOString()
    });
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    nameInput.value = '';
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    statusMsg.innerHTML = '<span class="success">âœ“ å·²æ·»åŠ å­¦ç”Ÿ: ' + name + '</span>';
    
    // é‡æ–°åŠ è½½åˆ—è¡¨
    await loadStudents();
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— æ·»åŠ å¤±è´¥: ' + error.message + '</span>';
    console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥:', error);
  }
}

// åˆ é™¤å­¦ç”Ÿ
window.deleteStudent = async function(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å­¦ç”Ÿå—ï¼Ÿ')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) return;
    
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨åˆ é™¤...</span>';
    
    // ä»æ•°æ®åº“åˆ é™¤
    await db.collection('students').doc(id).remove();
    
    statusMsg.innerHTML = '<span class="success">âœ“ å·²åˆ é™¤å­¦ç”Ÿ</span>';
    
    // é‡æ–°åŠ è½½åˆ—è¡¨
    await loadStudents();
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— åˆ é™¤å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆ é™¤å­¦ç”Ÿå¤±è´¥:', error);
  }
}
</script>

</body>
</html>