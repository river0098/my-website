<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>教师端 Dashboard(最终修复版)</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- 使用腾讯云 CDN 引入 CloudBase SDK -->
<script src="https://web.sdk.qcloud.com/cloudbase-js-sdk/latest/cloudbase.full.js"></script>
<style>
  body{font-family:"Segoe UI",Arial,"Microsoft YaHei";margin:0;background:#f9faff;color:#1f2749}
  header{background:#333;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  input,button{padding:8px 12px;margin:5px;border-radius:8px;border:1px solid #ccc;font-size:14px}
  button{cursor:pointer;background:#6653ff;color:#fff;border:none}
  button:hover{background:#4a3dd9}
  ul{list-style:none;padding:0}
  li{padding:6px 0;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center}
  .delete-btn{background:#e33}
  .delete-btn:hover{background:#c11}
  .status{font-size:14px;color:#666;margin-bottom:10px}
  .status.success{color:#0a0}
  .status.error{color:#e33}
</style>
</head>
<body>
<header>
  <h1>教师端 Dashboard</h1>
  <nav>
    <a href="index.html">学生端</a> | 
    <a href="dashboard.html">教师端</a>
  </nav>
</header>
<main>
  <div id="statusMsg" class="status">正在初始化...</div>
  <h2>学生管理</h2>
  <div>
    <input type="text" id="studentName" placeholder="输入学生姓名">
    <button onclick="addStudent()">添加学生</button>
  </div>
  <ul id="studentList"></ul>
</main>
<script>
window.addEventListener('DOMContentLoaded', async () => {
  const statusMsg = document.getElementById('statusMsg');
  
  if (typeof window.cloudbase === 'undefined') {
    statusMsg.textContent = "❌ SDK 未加载,请检查网络连接";
    statusMsg.classList.add('error');
    return;
  }
  
  statusMsg.textContent = "✅ SDK 已加载";
  statusMsg.classList.add('success');
  
  const CLOUD_ENV_ID = "cloud1-8gxc5t0wed3aa3e2";
  let app, auth, db;
  
  try {
    app = cloudbase.init({ env: CLOUD_ENV_ID });
    auth = app.auth({ persistence: "local" });
    db = app.database();
    statusMsg.textContent = "✅ 云开发已初始化";
  } catch (e) {
    statusMsg.textContent = "❌ 云开发初始化失败: " + (e.message || e);
    statusMsg.classList.remove('success');
    statusMsg.classList.add('error');
    console.error(e);
    return;
  }

  async function ensureLogin() {
    const loginState = await auth.getLoginState();
    if (!loginState) {
      await auth.anonymousAuthProvider().signIn();
      console.log('✅ 匿名登录成功');
    }
  }

  async function loadStudents() {
    try {
      await ensureLogin();
      const res = await db.collection("students").get();
      const list = document.getElementById("studentList");
      list.innerHTML = "";
      
      if (!res.data || res.data.length === 0) {
        list.innerHTML = '<li style="color:#999">暂无学生数据</li>';
        return;
      }
      
      res.data.forEach(item => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${item.name}</span>
          <button class="delete-btn" onclick="deleteStudent('${item._id}')">删除</button>
        `;
        list.appendChild(li);
      });
      
      statusMsg.textContent = `✅ 已加载 ${res.data.length} 个学生`;
      statusMsg.classList.add('success');
    } catch (err) {
      statusMsg.textContent = "❌ 加载失败: " + (err.message || err);
      statusMsg.classList.remove('success');
      statusMsg.classList.add('error');
      console.error('加载学生失败:', err);
    }
  }

  window.addStudent = async function() {
    const name = document.getElementById("studentName").value.trim();
    if (!name) {
      alert("请输入姓名");
      return;
    }
    
    try {
      await ensureLogin();
      await db.collection("students").add({ name });
      document.getElementById("studentName").value = "";
      statusMsg.textContent = `✅ 已添加学生: ${name}`;
      statusMsg.classList.add('success');
      loadStudents();
    } catch (err) {
      statusMsg.textContent = "❌ 添加失败: " + (err.message || err);
      statusMsg.classList.remove('success');
      statusMsg.classList.add('error');
      console.error('添加学生失败:', err);
    }
  }

  window.deleteStudent = async function(id) {
    if (!confirm("确定删除该学生?")) return;
    
    try {
      await ensureLogin();
      await db.collection("students").doc(id).remove();
      statusMsg.textContent = "✅ 已删除学生";
      statusMsg.classList.add('success');
      loadStudents();
    } catch (err) {
      statusMsg.textContent = "❌ 删除失败: " + (err.message || err);
      statusMsg.classList.remove('success');
      statusMsg.classList.add('error');
      console.error('删除学生失败:', err);
    }
  }

  loadStudents();
});
</script>
</body>
</html>
