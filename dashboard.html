<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>教师端 - 全员学习概览</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.6.0/cloudbase.full.js"></script>
<style>
  :root {
    --primary: #6653ff;
    --success: #2fb173;
    --danger: #f26c6c;
    --warning: #ff8f6b;
    --surface: rgba(255,255,255,0.95);
    --text: #1f2749;
    --muted: #6d7691;
  }
  
  * { box-sizing: border-box; }
  
  body {
    font-family: "Segoe UI", Arial, "Microsoft YaHei";
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  
  .dashboard-header {
    background: var(--surface);
    padding: 20px 30px;
    border-radius: 16px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .dashboard-header h1 {
    margin: 0;
    color: var(--text);
  }
  
  .back-link {
    background: var(--primary);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    transition: transform 0.2s;
  }
  
  .back-link:hover {
    transform: translateY(-2px);
  }
  
  .filters {
    background: var(--surface);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  
  .filter-item label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }
  
  .filter-item select,
  .filter-item input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
  }
  
  button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 83, 255, 0.3);
  }
  
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .stat-card h3 {
    margin: 0 0 10px 0;
    color: var(--muted);
    font-size: 14px;
    font-weight: 600;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--muted);
    margin-top: 5px;
  }
  
  .data-table {
    background: var(--surface);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .table-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .table-header h2 {
    margin: 0;
    color: var(--text);
    font-size: 18px;
  }
  
  .tab-buttons {
    display: flex;
    gap: 10px;
  }
  
  .tab-button {
    padding: 8px 16px;
    background: transparent;
    color: var(--muted);
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }
  
  .tab-button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--muted);
    font-size: 13px;
    border-bottom: 2px solid #eee;
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
    color: var(--text);
  }
  
  tbody tr:hover {
    background: #f8f9fa;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .badge-success {
    background: rgba(47, 177, 115, 0.1);
    color: var(--success);
  }
  
  .badge-danger {
    background: rgba(242, 108, 108, 0.1);
    color: var(--danger);
  }
  
  .badge-warning {
    background: rgba(255, 143, 107, 0.1);
    color: var(--warning);
  }
  
  .loading {
    text-align: center;
    padding: 40px;
    color: var(--muted);
  }
  
  .pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 20px;
  }
  
  .page-button {
    padding: 8px 12px;
    background: white;
    color: var(--text);
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .page-button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  .export-buttons {
    display: flex;
    gap: 10px;
  }
  
  .export-button {
    padding: 8px 16px;
    background: var(--success);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }

  .error-message {
    background: rgba(242, 108, 108, 0.1);
    color: var(--danger);
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    text-align: center;
  }
</style>
</head>
<body>

<div class="dashboard-header">
  <h1>📊 全员学习数据概览</h1>
  <a href="index.html" class="back-link">返回练习系统</a>
</div>

<div class="filters">
  <div class="filter-item">
    <label>学生筛选</label>
    <select id="studentFilter">
      <option value="">全部学生</option>
    </select>
  </div>
  <div class="filter-item">
    <label>练习类型</label>
    <select id="typeFilter">
      <option value="">全部类型</option>
      <option value="word">单词练习</option>
      <option value="grammar">语法练习</option>
      <option value="sentence">句子重组</option>
    </select>
  </div>
  <div class="filter-item">
    <label>开始日期</label>
    <input type="date" id="startDate">
  </div>
  <div class="filter-item">
    <label>结束日期</label>
    <input type="date" id="endDate">
  </div>
  <button onclick="refreshData()">🔄 刷新数据</button>
  <button onclick="exportToCSV()" class="export-button">📥 导出CSV</button>
</div>

<div class="stats-container">
  <div class="stat-card">
    <h3>总答题次数</h3>
    <div class="stat-value" id="totalSubmissions">-</div>
    <div class="stat-label">累计答题</div>
  </div>
  <div class="stat-card">
    <h3>平均正确率</h3>
    <div class="stat-value" id="avgAccuracy">-</div>
    <div class="stat-label">全员平均</div>
  </div>
  <div class="stat-card">
    <h3>活跃学生</h3>
    <div class="stat-value" id="activeStudents">-</div>
    <div class="stat-label">今日活跃</div>
  </div>
  <div class="stat-card">
    <h3>最高积分</h3>
    <div class="stat-value" id="topScore">-</div>
    <div class="stat-label" id="topScorer">-</div>
  </div>
</div>

<div class="data-table">
  <div class="table-header">
    <h2>详细数据</h2>
    <div class="tab-buttons">
      <button class="tab-button active" onclick="switchTab('students')">学生排行</button>
      <button class="tab-button" onclick="switchTab('recent')">最近答题</button>
      <button class="tab-button" onclick="switchTab('analysis')">错题分析</button>
    </div>
  </div>
  
  <div id="studentsTab" class="tab-content">
    <table>
      <thead>
        <tr>
          <th>排名</th>
          <th>学生姓名</th>
          <th>总积分</th>
          <th>答题次数</th>
          <th>正确率</th>
          <th>单词进度</th>
          <th>语法进度</th>
          <th>句子进度</th>
          <th>最后活跃</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody">
        <tr><td colspan="9" class="loading">加载中...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div id="recentTab" class="tab-content" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>时间</th>
          <th>学生</th>
          <th>类型</th>
          <th>题目</th>
          <th>答案</th>
          <th>结果</th>
          <th>用时</th>
        </tr>
      </thead>
      <tbody id="recentTableBody">
        <tr><td colspan="7" class="loading">加载中...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div id="analysisTab" class="tab-content" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>题目/单词</th>
          <th>错误次数</th>
          <th>错误率</th>
          <th>涉及学生</th>
          <th>常见错误</th>
        </tr>
      </thead>
      <tbody id="analysisTableBody">
        <tr><td colspan="5" class="loading">加载中...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="pagination" id="pagination"></div>

<script>
// CloudBase 初始化
let cloudConnected = false;
let app, db;

try {
  app = cloudbase.init({
    env: "cloud1-8gxc5t0wed3aa3e2"
  });
  db = app.database();
  cloudConnected = true;
  console.log('✅ CloudBase 连接成功');
} catch(err) {
  console.error('❌ CloudBase 连接失败:', err);
  document.body.innerHTML = '<div class="error-message">CloudBase 连接失败，请检查网络连接和配置</div>' + document.body.innerHTML;
}

// 学生列表（与主页面保持一致）
const students = [
  "焦良瑾","庄优岳","曾媛媛","陈伟誉","李煜文","吴沛宜","王泽霖","吴苑茹","陈佳糗","黄钰莹",
  "刘文锋","杨淳好","刘欣","梁鸿浩","杨映春","甘紫渊","黄书慧","谭铖淇","叶蕙仪","王诗涵",
  "谢家铄","张育东","余乐欢","余欣莹","何厚玮","李襄","曹淑怡","王馨怡","叶思翰"
];

// 填充学生筛选下拉框
const studentFilter = document.getElementById('studentFilter');
students.forEach(name => {
  const option = document.createElement('option');
  option.value = name;
  option.textContent = name;
  studentFilter.appendChild(option);
});

// 设置默认日期范围（最近7天）
const endDate = new Date();
const startDate = new Date();
startDate.setDate(startDate.getDate() - 7);
document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

// 全局数据存储
let currentData = {
  students: [],
  recent: [],
  analysis: []
};

// 切换标签页
function switchTab(tabName) {
  // 更新按钮状态
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // 显示对应内容
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = 'none';
  });
  document.getElementById(tabName + 'Tab').style.display = 'block';
  
  // 加载对应数据
  if(tabName === 'students') loadStudentsData();
  else if(tabName === 'recent') loadRecentData();
  else if(tabName === 'analysis') loadAnalysisData();
}

// 刷新数据
async function refreshData() {
  if (!cloudConnected) {
    alert('CloudBase 未连接，无法刷新数据');
    return;
  }
  
  await Promise.all([
    loadOverallStats(),
    loadStudentsData()
  ]);
}

// 加载整体统计
async function loadOverallStats() {
  if (!cloudConnected) return;
  
  try {
    const studentName = document.getElementById('studentFilter').value;
    const type = document.getElementById('typeFilter').value;
    
    // 获取总答题次数
    const wordCount = (await db.collection('word_submissions').count()).total || 0;
    const grammarCount = (await db.collection('grammar_submissions').count()).total || 0;
    const sentenceCount = (await db.collection('sentence_submissions').count()).total || 0;
    const totalCount = wordCount + grammarCount + sentenceCount;
    
    document.getElementById('totalSubmissions').textContent = totalCount;
    
    // 获取平均正确率（简化版本，实际需要聚合查询）
    const allSubmissions = [];
    if(!type || type === 'word') {
      const wordData = await db.collection('word_submissions').limit(100).get();
      allSubmissions.push(...(wordData.data || []));
    }
    if(!type || type === 'grammar') {
      const grammarData = await db.collection('grammar_submissions').limit(100).get();
      allSubmissions.push(...(grammarData.data || []));
    }
    if(!type || type === 'sentence') {
      const sentenceData = await db.collection('sentence_submissions').limit(100).get();
      allSubmissions.push(...(sentenceData.data || []));
    }
    
    const correctCount = allSubmissions.filter(s => s.is_correct).length;
    const accuracy = allSubmissions.length ? (correctCount / allSubmissions.length * 100).toFixed(1) : 0;
    document.getElementById('avgAccuracy').textContent = accuracy + '%';
    
    // 获取今日活跃学生数
    const today = new Date();
    today.setHours(0,0,0,0);
    const activeSet = new Set();
    allSubmissions.forEach(s => {
      if(new Date(s.timestamp) >= today) {
        activeSet.add(s.student_name);
      }
    });
    document.getElementById('activeStudents').textContent = activeSet.size;
    
    // 获取最高积分
    const scoreData = await db.collection('score_changes')
      .orderBy('total_score', 'desc')
      .limit(1)
      .get();
    
    if(scoreData.data && scoreData.data.length > 0) {
      const topData = scoreData.data[0];
      document.getElementById('topScore').textContent = topData.total_score || 0;
      document.getElementById('topScorer').textContent = topData.student_name || '-';
    }
    
  } catch(err) {
    console.error('加载统计失败:', err);
  }
}

// 加载学生排行数据
async function loadStudentsData() {
  if (!cloudConnected) return;
  
  try {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = '<tr><td colspan="9" class="loading">加载中...</td></tr>';
    
    // 获取所有学生的统计数据
    const studentStats = new Map();
    
    // 初始化所有学生
    students.forEach(name => {
      studentStats.set(name, {
        name: name,
        totalScore: 0,
        submissions: 0,
        correct: 0,
        wordProgress: 0,
        grammarProgress: 0,
        sentenceProgress: 0,
        lastActive: null
      });
    });
    
    // 简化版本的数据获取（实际应该使用聚合查询）
    const scoreData = await db.collection('score_changes').limit(100).get();
    if (scoreData.data) {
      scoreData.data.forEach(record => {
        if(studentStats.has(record.student_name)) {
          const stat = studentStats.get(record.student_name);
          stat.totalScore = Math.max(stat.totalScore, record.total_score || 0);
        }
      });
    }
    
    // 转换为数组并排序
    const statsArray = Array.from(studentStats.values())
      .sort((a, b) => b.totalScore - a.totalScore);
    
    // 渲染表格
    tbody.innerHTML = '';
    statsArray.forEach((stat, index) => {
      const accuracy = stat.submissions ? (stat.correct / stat.submissions * 100).toFixed(1) : 0;
      const lastActiveStr = stat.lastActive 
        ? new Date(stat.lastActive).toLocaleDateString('zh-CN')
        : '从未';
      
      const row = `
        <tr>
          <td>${index + 1}</td>
          <td><strong>${stat.name}</strong></td>
          <td><span class="badge badge-warning">${stat.totalScore}</span></td>
          <td>${stat.submissions}</td>
          <td>${accuracy}%</td>
          <td>${stat.wordProgress}</td>
          <td>${stat.grammarProgress}</td>
          <td>${stat.sentenceProgress}</td>
          <td>${lastActiveStr}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    currentData.students = statsArray;
    
  } catch(err) {
    console.error('加载学生数据失败:', err);
    document.getElementById('studentsTableBody').innerHTML = 
      '<tr><td colspan="9" class="loading">加载失败，请重试</td></tr>';
  }
}

// 加载最近答题记录
async function loadRecentData() {
  if (!cloudConnected) return;
  
  try {
    const tbody = document.getElementById('recentTableBody');
    tbody.innerHTML = '<tr><td colspan="7" class="loading">加载中...</td></tr>';
    
    // 获取筛选条件
    const studentName = document.getElementById('studentFilter').value;
    const type = document.getElementById('typeFilter').value;
    
    const recentSubmissions = [];
    
    // 获取各类提交记录（简化版本）
    if(!type || type === 'word') {
      let query = db.collection('word_submissions');
      if(studentName) query = query.where({student_name: studentName});
      const data = await query.orderBy('timestamp', 'desc').limit(20).get();
      if (data.data) {
        data.data.forEach(item => {
          recentSubmissions.push({
            ...item,
            type: '单词',
            question: item.word,
            answer: item.user_answer || '未作答'
          });
        });
      }
    }
    
    // 按时间排序
    recentSubmissions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // 渲染表格
    tbody.innerHTML = '';
    recentSubmissions.slice(0, 50).forEach(item => {
      const time = new Date(item.timestamp).toLocaleString('zh-CN');
      const resultBadge = item.is_correct 
        ? '<span class="badge badge-success">正确</span>'
        : '<span class="badge badge-danger">错误</span>';
      const timeSpent = item.time_spent || '-';
      
      const row = `
        <tr>
          <td>${time}</td>
          <td>${item.student_name}</td>
          <td>${item.type}</td>
          <td>${item.question}</td>
          <td>${item.answer}</td>
          <td>${resultBadge}</td>
          <td>${timeSpent}秒</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    currentData.recent = recentSubmissions;
    
  } catch(err) {
    console.error('加载最近记录失败:', err);
    document.getElementById('recentTableBody').innerHTML = 
      '<tr><td colspan="7" class="loading">加载失败，请重试</td></tr>';
  }
}

// 加载错题分析
async function loadAnalysisData() {
  if (!cloudConnected) return;
  
  try {
    const tbody = document.getElementById('analysisTableBody');
    tbody.innerHTML = '<tr><td colspan="5" class="loading">加载中...</td></tr>';
    
    const errorAnalysis = new Map();
    
    // 分析单词错题（简化版本）
    const wordData = await db.collection('word_submissions')
      .where({is_correct: false})
      .limit(50)
      .get();
    
    if (wordData.data) {
      wordData.data.forEach(item => {
        const key = item.word;
        if(!errorAnalysis.has(key)) {
          errorAnalysis.set(key, {
            question: key,
            type: '单词',
            errorCount: 0,
            totalCount: 0,
            students: new Set(),
            wrongAnswers: new Map()
          });
        }
        const analysis = errorAnalysis.get(key);
        analysis.errorCount++;
        analysis.students.add(item.student_name);
        
        if(item.user_answer) {
          const count = analysis.wrongAnswers.get(item.user_answer) || 0;
          analysis.wrongAnswers.set(item.user_answer, count + 1);
        }
      });
    }
    
    // 转换为数组并排序
    const analysisArray = Array.from(errorAnalysis.values())
      .map(item => ({
        ...item,
        errorRate: item.totalCount ? (item.errorCount / item.totalCount * 100).toFixed(1) : 100,
        studentsList: Array.from(item.students).slice(0, 3).join('、'),
        commonErrors: Array.from(item.wrongAnswers.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 2)
          .map(([answer, count]) => `${answer}(${count}次)`)
          .join('、')
      }))
      .sort((a, b) => b.errorCount - a.errorCount);
    
    // 渲染表格
    tbody.innerHTML = '';
    analysisArray.slice(0, 30).forEach(item => {
      const row = `
        <tr>
          <td>${item.question}</td>
          <td><span class="badge badge-danger">${item.errorCount}</span></td>
          <td>${item.errorRate}%</td>
          <td>${item.studentsList}${item.students.size > 3 ? '等' : ''}</td>
          <td>${item.commonErrors || '-'}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    currentData.analysis = analysisArray;
    
  } catch(err) {
    console.error('加载错题分析失败:', err);
    document.getElementById('analysisTableBody').innerHTML = 
      '<tr><td colspan="5" class="loading">加载失败，请重试</td></tr>';
  }
}

// 导出CSV
function exportToCSV() {
  const activeTab = document.querySelector('.tab-button.active').textContent;
  let csvContent = '';
  let filename = '';
  
  if(activeTab === '学生排行') {
    csvContent = '排名,学生姓名,总积分,答题次数,正确率,单词进度,语法进度,句子进度,最后活跃\n';
    currentData.students.forEach((stat, index) => {
      const accuracy = stat.submissions ? (stat.correct / stat.submissions * 100).toFixed(1) : 0;
      const lastActive = stat.lastActive ? new Date(stat.lastActive).toLocaleDateString('zh-CN') : '从未';
      csvContent += `${index + 1},${stat.name},${stat.totalScore},${stat.submissions},${accuracy}%,${stat.wordProgress},${stat.grammarProgress},${stat.sentenceProgress},${lastActive}\n`;
    });
    filename = `学生排行_${new Date().toLocaleDateString('zh-CN')}.csv`;
  } else if(activeTab === '最近答题') {
    csvContent = '时间,学生,类型,题目,答案,结果,用时\n';
    currentData.recent.forEach(item => {
      const time = new Date(item.timestamp).toLocaleString('zh-CN');
      const result = item.is_correct ? '正确' : '错误';
      const timeSpent = item.time_spent || '-';
      csvContent += `${time},${item.student_name},${item.type},"${item.question}","${item.answer}",${result},${timeSpent}\n`;
    });
    filename = `最近答题_${new Date().toLocaleDateString('zh-CN')}.csv`;
  } else if(activeTab === '错题分析') {
    csvContent = '题目,错误次数,错误率,涉及学生,常见错误\n';
    currentData.analysis.forEach(item => {
      csvContent += `"${item.question}",${item.errorCount},${item.errorRate}%,"${item.studentsList}","${item.commonErrors}"\n`;
    });
    filename = `错题分析_${new Date().toLocaleDateString('zh-CN')}.csv`;
  }
  
  // 添加BOM以支持中文
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// 页面加载时初始化
window.onload = () => {
  if (cloudConnected) {
    refreshData();
  }
};

// 定时刷新（每60秒）
if (cloudConnected) {
  setInterval(refreshData, 60000);
}
</script>

</body>
</html>