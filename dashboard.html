<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ•™å¸ˆç«¯ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- è…¾è®¯äº‘ CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>
<script src="student_data.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f9faff;color:#1f2749}
  header{background:#333;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  input,button{padding:10px 14px;margin:5px;border-radius:6px;border:1px solid #ced4da;font-size:14px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  ul{list-style:none;padding:0;margin-top:20px}
  li{padding:12px;border:1px solid #e9ecef;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;background:#fff;transition:all 0.3s ease;cursor:pointer}
  li:hover{background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px}
  .delete-btn:hover{background:#c82333}
  .student-name{font-size:16px;color:#495057}
  .empty-state{text-align:center;padding:40px;color:#6c757d;cursor:default}
  .loading{text-align:center;padding:20px;color:#6c757d}
  .student-count{background:#e7f3ff;color:#0066cc;padding:5px 10px;border-radius:4px;font-size:14px}
  .student-list-hint{font-size:12px;color:#6c757d;margin-top:6px}
  .analytic-chart{margin-top:12px}
  .bar-row{display:flex;align-items:center;margin:6px 0}
  .bar-label{width:120px;font-size:13px;color:#495057;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar-track{flex:1;height:12px;background:#e9ecef;border-radius:999px;margin:0 10px;position:relative;overflow:hidden}
  .bar-fill{height:100%;background:linear-gradient(90deg,#6653ff,#4a3dd9);border-radius:999px}
  .bar-value{font-size:12px;color:#333;font-weight:bold}
  .detail-box{margin-top:20px;padding:15px;border:1px solid #e9ecef;border-radius:8px;background:#fff}
  .detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .detail-title{font-size:18px;margin:0;color:#333}
  .detail-close{background:none;border:none;font-size:20px;cursor:pointer;color:#999}
  .detail-close:hover{color:#333}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:15px 0}
  .summary-card{padding:12px;border-radius:8px;background:#f8f9ff;border:1px solid #e3e7ff;text-align:center}
  .summary-label{font-size:12px;color:#6c757d}
  .summary-number{font-size:20px;font-weight:bold;color:#4a3dd9;margin-top:4px}
  .log-table{width:100%;border-collapse:collapse;margin-top:10px}
  .log-table th,.log-table td{border:1px solid #e9ecef;padding:8px;font-size:12px;text-align:center}
  .log-table th{background:#f1f3f5;color:#495057}
  .log-empty{padding:20px;text-align:center;color:#6c757d;font-size:13px}
</style>
</head>
<body>
<header>
  <h1>æ•™å¸ˆç«¯ Dashboard</h1>
  <nav>
    <a href="index.html">å­¦ç”Ÿç«¯</a> | 
    <a href="dashboard.html">æ•™å¸ˆç«¯</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>ç³»ç»ŸçŠ¶æ€</h3>
    <div id="statusMsg">æ­£åœ¨åˆå§‹åŒ–...</div>
  </div>
  
  <div class="status-box">
    <h3>æ·»åŠ å­¦ç”Ÿ</h3>
    <div style="display:flex;align-items:center;margin-bottom:15px">
      <input type="text" id="studentName" placeholder="è¾“å…¥å­¦ç”Ÿå§“å" style="flex:1">
      <button onclick="addStudent()">æ·»åŠ å­¦ç”Ÿ</button>
      <button onclick="loadStudents()" style="background:#28a745">åˆ·æ–°åˆ—è¡¨</button>
    </div>
  </div>
  
  <div class="status-box" style="background:#f8f9ff;border:2px solid #6653ff;border-radius:12px">
    <h3 style="color:#6653ff;margin-top:0">ğŸ“š ç­çº§å­¦ç”Ÿç®¡ç†</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px">
      <div style="padding:15px;background:#fff;border-radius:8px;border:1px solid #e9ecef">
        <h4 id="class31Title" style="color:#495057;margin-top:0;margin-bottom:10px"></h4>
        <div id="class31Names" style="font-size:13px;color:#6c757d;margin-bottom:10px"></div>
        <button onclick="importClass31Students()" style="background:#28a745;width:100%">
          ğŸ“¥ å¯¼å…¥31ç­å­¦ç”Ÿ
        </button>
      </div>
      <div style="padding:15px;background:#fff;border-radius:8px;border:1px solid #e9ecef">
        <h4 id="class39Title" style="color:#495057;margin-top:0;margin-bottom:10px"></h4>
        <div id="class39Names" style="font-size:13px;color:#6c757d;margin-bottom:10px"></div>
        <button onclick="importClass39Students()" style="background:#17a2b8;width:100%">
          ğŸ“¥ å¯¼å…¥39ç­å­¦ç”Ÿ
        </button>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="importAllButton" onclick="importAllStudents()" style="background:#ffc107;color:#000;font-weight:bold">
        ğŸ“¥ å¯¼å…¥æ‰€æœ‰å­¦ç”Ÿ
      </button>
      <button onclick="clearAllStudents()" style="background:#dc3545">
        ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿ
      </button>
      <span id="importStatus" style="color:#6c757d;font-size:13px"></span>
    </div>
    <div style="margin-top:10px;padding:8px;background:#e7f3ff;border-radius:6px;font-size:13px;color:#0066cc">
      ğŸ’¡ æç¤ºï¼šç‚¹å‡»ç›¸åº”æŒ‰é’®å¯å¯¼å…¥å¯¹åº”ç­çº§çš„å­¦ç”Ÿï¼Œæˆ–ä¸€æ¬¡æ€§å¯¼å…¥æ‰€æœ‰å­¦ç”Ÿ
    </div>
  </div>
  
  <div class="status-box">
    <h3>ğŸ“Š å­¦ç”Ÿç»ƒä¹ æ¦‚è§ˆ</h3>
    <div id="practiceChart" class="analytic-chart"></div>
    <div class="student-list-hint">æç¤ºï¼šå›¾è¡¨å±•ç¤ºç»ƒä¹ é¢˜ç›®æ•°é‡æ’åé å‰çš„å­¦ç”Ÿï¼Œç‚¹å‡»ä¸‹æ–¹å­¦ç”Ÿå§“åå¯æŸ¥çœ‹è¯¦ç»†è®°å½•ã€‚</div>
  </div>
  
  <div id="listContainer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>å­¦ç”Ÿåˆ—è¡¨</h3>
      <span id="studentCount" class="student-count">å…± 0 ä¸ªå­¦ç”Ÿ</span>
    </div>
    <ul id="studentList">
      <li class="loading">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</li>
    </ul>
  </div>
  
  <div id="studentDetail" class="detail-box" style="display:none">
    <div class="detail-header">
      <h3 id="detailTitle" class="detail-title">å­¦ç”Ÿç»ƒä¹ è¯¦æƒ…</h3>
      <button class="detail-close" onclick="hideStudentDetail()">Ã—</button>
    </div>
    <div id="detailContent">è¯·é€‰æ‹©ä¸€ä½å­¦ç”ŸæŸ¥çœ‹ç»ƒä¹ æ•°æ®</div>
  </div>
  
  <div class="status-box" style="background:#fff3cd;border-left:4px solid #ffc107">
    <h4>æç¤º</h4>
    <p>â€¢ æ·»åŠ å­¦ç”Ÿåï¼Œæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°è…¾è®¯äº‘æ•°æ®åº“</p>
    <p>â€¢ å­¦ç”Ÿç«¯ä¼šè‡ªåŠ¨è¯»å–è¿™é‡Œæ·»åŠ çš„å­¦ç”Ÿæ•°æ®</p>
    <p>â€¢ æ•°æ®ä¼šåœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°</p>
  </div>
</main>

<script>
// å…¨å±€å˜é‡
let app = null;
let auth = null;
let db = null;
const practiceDataStore = {};
const practiceChartEl = document.getElementById('practiceChart');
const detailBox = document.getElementById('studentDetail');
const detailTitle = document.getElementById('detailTitle');
const detailContent = document.getElementById('detailContent');

if (practiceChartEl) {
  practiceChartEl.innerHTML = '<div class="log-empty">ç­‰å¾…åŠ è½½å­¦ç”Ÿæ•°æ®...</div>';
}

function seededRandom(seed) {
  let value = seed % 2147483647;
  if (value <= 0) value += 2147483646;
  return function() {
    value = value * 16807 % 2147483647;
    return (value - 1) / 2147483646;
  };
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash) + 1;
}

function generatePracticeData(name, className) {
  const seed = hashString(`${name}-${className}`);
  const random = seededRandom(seed);
  const sessionCount = 4 + Math.floor(random() * 6);
  const logs = [];
  let totalQuestions = 0;
  let totalCorrect = 0;
  let totalMinutes = 0;
  const datasetPool = ['è¯æ±‡å†²åˆº', 'é«˜é¢‘è¯­æ³•', 'å®Œå½¢å¡«ç©º', 'é˜…è¯»ç†è§£', 'å†™ä½œç´ æ'];

  for (let i = 0; i < sessionCount; i++) {
    const questions = 15 + Math.floor(random() * 15);
    const accuracy = 0.6 + random() * 0.35;
    const correct = Math.round(questions * accuracy);
    const duration = 8 + Math.floor(random() * 12);
    const dataset = datasetPool[Math.floor(random() * datasetPool.length)];
    const timestamp = new Date(Date.now() - (i * (random() * 18 + 6)) * 3600 * 1000);

    totalQuestions += questions;
    totalCorrect += correct;
    totalMinutes += duration;

    logs.push({
      timestamp,
      dataset,
      questions,
      correct,
      accuracy: Math.round((correct / questions) * 100),
      duration
    });
  }

  logs.sort((a, b) => b.timestamp - a.timestamp);

  return {
    name,
    className,
    sessions: sessionCount,
    totalQuestions,
    totalCorrect,
    totalMinutes,
    averageAccuracy: Math.round((totalCorrect / totalQuestions) * 100),
    logs
  };
}

function ensurePracticeData(student) {
  const name = student.name || 'æœªçŸ¥';
  if (!practiceDataStore[name]) {
    const className = student.class || student.className || 'æœªåˆ†ç­';
    practiceDataStore[name] = generatePracticeData(name, className);
  }
  return practiceDataStore[name];
}

function updatePracticeChart(students) {
  if (!practiceChartEl) return;
  if (!students || !students.length) {
    practiceChartEl.innerHTML = '<div class="log-empty">æš‚æ— å­¦ç”Ÿç»ƒä¹ æ•°æ®</div>';
    return;
  }

  const datasets = students.map(student => {
    const data = ensurePracticeData(student);
    return {
      name: student.name || 'æœªçŸ¥',
      totalQuestions: data.totalQuestions
    };
  });

  datasets.sort((a, b) => b.totalQuestions - a.totalQuestions);
  const top = datasets.slice(0, 8);
  const maxValue = Math.max(...top.map(item => item.totalQuestions), 1);

  practiceChartEl.innerHTML = top.map(item => {
    const percentage = Math.round((item.totalQuestions / maxValue) * 100);
    return `
      <div class="bar-row">
        <span class="bar-label" title="${item.name}">${item.name}</span>
        <div class="bar-track">
          <div class="bar-fill" style="width:${percentage}%"></div>
        </div>
        <span class="bar-value">${item.totalQuestions} é¢˜</span>
      </div>
    `;
  }).join('');
}

function showStudentDetail(student) {
  const data = ensurePracticeData(student);
  if (!detailBox || !detailTitle || !detailContent) return;

  detailTitle.textContent = `${data.name} Â· ${data.className}`;

  const summaryHtml = `
    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">ç»ƒä¹ æ¬¡æ•°</div>
        <div class="summary-number">${data.sessions}</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">æ€»é¢˜é‡</div>
        <div class="summary-number">${data.totalQuestions}</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">æ­£ç¡®ç‡</div>
        <div class="summary-number">${data.averageAccuracy}%</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">ç´¯è®¡ç”¨æ—¶</div>
        <div class="summary-number">${data.totalMinutes} åˆ†é’Ÿ</div>
      </div>
    </div>
  `;

  const logsHtml = data.logs.length ? `
    <table class="log-table">
      <thead>
        <tr>
          <th>ç»ƒä¹ æ—¶é—´</th>
          <th>é¢˜åº“</th>
          <th>é¢˜é‡</th>
          <th>æ­£ç¡®æ•°</th>
          <th>æ­£ç¡®ç‡</th>
          <th>ç”¨æ—¶</th>
        </tr>
      </thead>
      <tbody>
        ${data.logs.map(log => `
          <tr>
            <td>${log.timestamp.toLocaleString()}</td>
            <td>${log.dataset}</td>
            <td>${log.questions}</td>
            <td>${log.correct}</td>
            <td>${log.accuracy}%</td>
            <td>${log.duration} åˆ†é’Ÿ</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  ` : '<div class="log-empty">æš‚æ— ç»ƒä¹ è®°å½•</div>';

  detailContent.innerHTML = summaryHtml + logsHtml;
  detailBox.style.display = 'block';
}

function hideStudentDetail() {
  if (detailBox) {
    detailBox.style.display = 'none';
    if (detailTitle) {
      detailTitle.textContent = 'å­¦ç”Ÿç»ƒä¹ è¯¦æƒ…';
    }
    if (detailContent) {
      detailContent.innerHTML = 'è¯·é€‰æ‹©ä¸€ä½å­¦ç”ŸæŸ¥çœ‹ç»ƒä¹ æ•°æ®';
    }
  }
}

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
  console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
  renderClassCards();
  setTimeout(initApp, 500);
});

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
  const statusMsg = document.getElementById('statusMsg');
  
  // æ£€æŸ¥SDK
  if (typeof cloudbase === 'undefined') {
    statusMsg.innerHTML = '<span class="error">âœ— SDK æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</span>';
    return;
  }
  
  statusMsg.innerHTML = '<span class="success">âœ“ SDK å·²åŠ è½½</span>';
  console.log('SDKå·²åŠ è½½');
  
  try {
    // åˆå§‹åŒ–CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // è®¾ç½®è®¤è¯
    auth = app.auth({
      persistence: 'local'
    });
    
    // è·å–æ•°æ®åº“å¼•ç”¨
    db = app.database();
    
    statusMsg.innerHTML = '<span class="success">âœ“ äº‘å¼€å‘å·²åˆå§‹åŒ–</span>';
    console.log('CloudBaseåˆå§‹åŒ–æˆåŠŸ');
    
    // ç¡®ä¿ç™»å½•
    const loginSuccess = await ensureLogin();
    
    if (loginSuccess) {
      // è‡ªåŠ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨
      console.log('å¼€å§‹è‡ªåŠ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨...');
      await loadStudents();
      
      // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
      setInterval(loadStudents, 30000);
    }
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// ç¡®ä¿ç™»å½•
async function ensureLogin() {
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      console.log('å¼€å§‹åŒ¿åç™»å½•...');
      statusMsg.innerHTML = '<span class="info">æ­£åœ¨è¿›è¡ŒåŒ¿åç™»å½•...</span>';
      await auth.anonymousAuthProvider().signIn();
      statusMsg.innerHTML = '<span class="success">âœ“ åŒ¿åç™»å½•æˆåŠŸ</span>';
      console.log('åŒ¿åç™»å½•æˆåŠŸ');
    } else {
      statusMsg.innerHTML = '<span class="success">âœ“ å·²ç™»å½•</span>';
      console.log('å·²æœ‰ç™»å½•çŠ¶æ€');
    }
    
    return true;
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— ç™»å½•å¤±è´¥: ' + error.message + '</span>';
    console.error('ç™»å½•å¤±è´¥:', error);
    return false;
  }
}

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨è°ƒç”¨ï¼‰
async function loadStudents() {
  const list = document.getElementById('studentList');
  const statusMsg = document.getElementById('statusMsg');
  const countSpan = document.getElementById('studentCount');
  
  console.log('æ­£åœ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨...');
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      console.log('æœªç™»å½•ï¼Œæ— æ³•åŠ è½½æ•°æ®');
      return;
    }
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    if (list.children.length === 0 || list.querySelector('.empty-state')) {
      list.innerHTML = '<li class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</li>';
    }
    
    // è¯»å–å­¦ç”Ÿæ•°æ®
    console.log('å¼€å§‹è¯»å–studentsé›†åˆ...');
    const res = await db.collection('students').get();
    console.log('æŸ¥è¯¢ç»“æœ:', res);
    
    // æ¸…ç©ºåˆ—è¡¨
    list.innerHTML = '';
    
    if (!res.data || res.data.length === 0) {
      list.innerHTML = '<li class="empty-state">æš‚æ— å­¦ç”Ÿæ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å­¦ç”Ÿ"æŒ‰é’®æ·»åŠ </li>';
      statusMsg.innerHTML = '<span class="warning">æš‚æ— å­¦ç”Ÿæ•°æ®</span>';
      countSpan.textContent = 'å…± 0 ä¸ªå­¦ç”Ÿ';
      console.log('æ•°æ®åº“ä¸­æš‚æ— å­¦ç”Ÿ');
      if (practiceChartEl) practiceChartEl.innerHTML = '<div class="log-empty">æš‚æ— å­¦ç”Ÿç»ƒä¹ æ•°æ®</div>';
      hideStudentDetail();
      return;
    }

    // æŒ‰å§“åæ’åº
    const sortedData = res.data.sort((a, b) => {
      return (a.name || '').localeCompare(b.name || '', 'zh-CN');
    });
    
    // æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
    console.log(`æ‰¾åˆ° ${sortedData.length} ä¸ªå­¦ç”Ÿ`);
    sortedData.forEach((student, index) => {
      const li = document.createElement('li');
      li.style.animationDelay = (index * 0.1) + 's';
      const classLabel = student.class || 'æœªåˆ†ç­';
      li.innerHTML = `
        <span class="student-name">ğŸ“š ${student.name}</span>
        <button class="delete-btn" onclick="deleteStudent('${student._id}')">åˆ é™¤</button>
      `;
      li.dataset.name = student.name;
      li.dataset.className = classLabel;
      li.addEventListener('click', () => showStudentDetail(student));
      const deleteBtn = li.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', event => event.stopPropagation());
      }
      list.appendChild(li);
    });

    statusMsg.innerHTML = '<span class="success">âœ“ å·²åŠ è½½ ' + sortedData.length + ' ä¸ªå­¦ç”Ÿ</span>';
    countSpan.textContent = 'å…± ' + sortedData.length + ' ä¸ªå­¦ç”Ÿ';
    console.log('å­¦ç”Ÿåˆ—è¡¨åŠ è½½å®Œæˆ');

    updatePracticeChart(sortedData);

  } catch (error) {
    list.innerHTML = '<li class="empty-state">åŠ è½½å¤±è´¥: ' + error.message + '</li>';
    statusMsg.innerHTML = '<span class="error">âœ— åŠ è½½å¤±è´¥: ' + error.message + '</span>';
    countSpan.textContent = 'åŠ è½½å¤±è´¥';
    console.error('åŠ è½½å­¦ç”Ÿå¤±è´¥:', error);
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      statusMsg.innerHTML += '<br><span class="warning">è¯·æ£€æŸ¥æ•°æ®åº“æƒé™è®¾ç½®</span>';
    }

    if (practiceChartEl) practiceChartEl.innerHTML = '<div class="log-empty">æš‚æ— æ³•è·å–ç»ƒä¹ æ•°æ®</div>';
    hideStudentDetail();
  }
}

// æ·»åŠ å­¦ç”Ÿ
window.addStudent = async function() {
  const nameInput = document.getElementById('studentName');
  const name = nameInput.value.trim();
  const statusMsg = document.getElementById('statusMsg');
  
  if (!name) {
    alert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');
    nameInput.focus();
    return;
  }
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('æœªç™»å½•ï¼Œè¯·åˆ·æ–°é¡µé¢');
      return;
    }
    
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨æ·»åŠ å­¦ç”Ÿ...</span>';
    console.log('æ­£åœ¨æ·»åŠ å­¦ç”Ÿ:', name);
    
    // æ·»åŠ åˆ°æ•°æ®åº“
    const result = await db.collection('students').add({
      name: name,
      createdAt: new Date().toISOString()
    });
    
    console.log('æ·»åŠ æˆåŠŸï¼Œæ–‡æ¡£ID:', result.id);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    nameInput.value = '';
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    statusMsg.innerHTML = '<span class="success">âœ“ å·²æˆåŠŸæ·»åŠ å­¦ç”Ÿ: ' + name + '</span>';
    
    // è‡ªåŠ¨é‡æ–°åŠ è½½åˆ—è¡¨
    setTimeout(() => {
      loadStudents();
    }, 500);
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— æ·»åŠ å¤±è´¥: ' + error.message + '</span>';
    console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥:', error);
    alert('æ·»åŠ å¤±è´¥: ' + error.message);
  }
}

// åˆ é™¤å­¦ç”Ÿ
window.deleteStudent = async function(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å­¦ç”Ÿå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('æœªç™»å½•ï¼Œè¯·åˆ·æ–°é¡µé¢');
      return;
    }
    
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨åˆ é™¤...</span>';
    console.log('æ­£åœ¨åˆ é™¤å­¦ç”Ÿï¼ŒID:', id);
    
    // ä»æ•°æ®åº“åˆ é™¤
    await db.collection('students').doc(id).remove();
    
    console.log('åˆ é™¤æˆåŠŸ');
    statusMsg.innerHTML = '<span class="success">âœ“ å·²åˆ é™¤å­¦ç”Ÿ</span>';
    
    // è‡ªåŠ¨é‡æ–°åŠ è½½åˆ—è¡¨
    setTimeout(() => {
      loadStudents();
    }, 500);
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— åˆ é™¤å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆ é™¤å­¦ç”Ÿå¤±è´¥:', error);
    alert('åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

// å†…ç½®å­¦ç”Ÿåå•
const STUDENT_LISTS = {
  class31: (window.STUDENT_ROSTERS_BY_KEY && Array.isArray(window.STUDENT_ROSTERS_BY_KEY.class31))
    ? window.STUDENT_ROSTERS_BY_KEY.class31.slice()
    : (window.STUDENT_ROSTERS && Array.isArray(window.STUDENT_ROSTERS['31ç­'])
      ? window.STUDENT_ROSTERS['31ç­'].slice()
      : []),
  class39: (window.STUDENT_ROSTERS_BY_KEY && Array.isArray(window.STUDENT_ROSTERS_BY_KEY.class39))
    ? window.STUDENT_ROSTERS_BY_KEY.class39.slice()
    : (window.STUDENT_ROSTERS && Array.isArray(window.STUDENT_ROSTERS['39ç­'])
      ? window.STUDENT_ROSTERS['39ç­'].slice()
      : [])
};

function renderClassCards() {
  const class31 = STUDENT_LISTS.class31 || [];
  const class39 = STUDENT_LISTS.class39 || [];

  const class31Title = document.getElementById('class31Title');
  if (class31Title) {
    class31Title.textContent = `ğŸ« 31ç­è‹±è¯­ç”Ÿ (${class31.length}äºº)`;
  }
  const class31Names = document.getElementById('class31Names');
  if (class31Names) {
    class31Names.textContent = class31.length ? class31.join('ã€') : 'æš‚æ— åå•';
  }

  const class39Title = document.getElementById('class39Title');
  if (class39Title) {
    class39Title.textContent = `ğŸ« 39ç­å­¦ç”Ÿ (${class39.length}äºº)`;
  }
  const class39Names = document.getElementById('class39Names');
  if (class39Names) {
    class39Names.textContent = class39.length ? class39.join('ã€') : 'æš‚æ— åå•';
  }

  const importAllButton = document.getElementById('importAllButton');
  if (importAllButton) {
    const total = class31.length + class39.length;
    importAllButton.textContent = `ğŸ“¥ å¯¼å…¥æ‰€æœ‰å­¦ç”Ÿ (${total}äºº)`;
  }
}

// é€šç”¨å¯¼å…¥å­¦ç”Ÿå‡½æ•°
async function importStudents(studentList, className) {
  const statusMsg = document.getElementById('statusMsg');
  const importStatus = document.getElementById('importStatus');
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('æœªç™»å½•ï¼Œè¯·åˆ·æ–°é¡µé¢');
      return;
    }
    
    importStatus.textContent = `æ­£åœ¨å¯¼å…¥${className}å­¦ç”Ÿ...`;
    importStatus.style.color = '#17a2b8';
    statusMsg.innerHTML = `<span class="info">æ­£åœ¨å¯¼å…¥${className}å­¦ç”Ÿ...</span>`;
    
    console.log(`å¼€å§‹å¯¼å…¥${className}å­¦ç”Ÿ:`, studentList);
    
    // æ‰¹é‡æ·»åŠ åˆ°æ•°æ®åº“
    const promises = studentList.map(name => 
      db.collection('students').add({
        name: name,
        class: className,
        createdAt: new Date().toISOString()
      })
    );
    
    const results = await Promise.all(promises);
    console.log(`${className}å¯¼å…¥æˆåŠŸï¼Œæ·»åŠ äº†`, results.length, 'ä¸ªå­¦ç”Ÿ');
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    importStatus.textContent = `âœ… æˆåŠŸå¯¼å…¥${className} ${studentList.length} ä¸ªå­¦ç”Ÿ`;
    importStatus.style.color = '#28a745';
    statusMsg.innerHTML = `<span class="success">âœ“ å·²æˆåŠŸå¯¼å…¥${className} ${studentList.length} ä¸ªå­¦ç”Ÿ</span>`;
    
    // è‡ªåŠ¨é‡æ–°åŠ è½½åˆ—è¡¨
    setTimeout(() => {
      loadStudents();
      // 3ç§’åæ¸…ç©ºçŠ¶æ€æ¶ˆæ¯
      setTimeout(() => {
        importStatus.textContent = '';
      }, 3000);
    }, 500);
    
  } catch (error) {
    console.error(`${className}å¯¼å…¥å¤±è´¥:`, error);
    importStatus.textContent = `âŒ ${className}å¯¼å…¥å¤±è´¥: ${error.message}`;
    importStatus.style.color = '#dc3545';
    statusMsg.innerHTML = `<span class="error">âœ— ${className}å¯¼å…¥å¤±è´¥: ${error.message}</span>`;
  }
}

// å¯¼å…¥31ç­å­¦ç”Ÿ
window.importClass31Students = async function() {
  await importStudents(STUDENT_LISTS.class31, '31ç­');
}

// å¯¼å…¥39ç­å­¦ç”Ÿ
window.importClass39Students = async function() {
  await importStudents(STUDENT_LISTS.class39, '39ç­');
}

// å¯¼å…¥æ‰€æœ‰å­¦ç”Ÿ
window.importAllStudents = async function() {
  const allStudents = [...STUDENT_LISTS.class31, ...STUDENT_LISTS.class39];
  await importStudents(allStudents, 'æ‰€æœ‰ç­çº§');
}

// æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿ
window.clearAllStudents = async function() {
  if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿå—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ï¼')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  const importStatus = document.getElementById('importStatus');
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('æœªç™»å½•ï¼Œè¯·åˆ·æ–°é¡µé¢');
      return;
    }
    
    importStatus.textContent = 'æ­£åœ¨æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿ...';
    importStatus.style.color = '#dc3545';
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿ...</span>';
    
    // è·å–æ‰€æœ‰å­¦ç”Ÿå¹¶åˆ é™¤
    const res = await db.collection('students').get();
    if (res.data && res.data.length > 0) {
      const deletePromises = res.data.map(student => 
        db.collection('students').doc(student._id).remove()
      );
      await Promise.all(deletePromises);
    }
    
    console.log('æ‰€æœ‰å­¦ç”Ÿå·²æ¸…ç©º');
    importStatus.textContent = 'âœ… å·²æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿ';
    importStatus.style.color = '#28a745';
    statusMsg.innerHTML = '<span class="success">âœ“ å·²æ¸…ç©ºæ‰€æœ‰å­¦ç”Ÿ</span>';
    Object.keys(practiceDataStore).forEach(key => delete practiceDataStore[key]);
    
    // è‡ªåŠ¨é‡æ–°åŠ è½½åˆ—è¡¨
    setTimeout(() => {
      loadStudents();
      // 3ç§’åæ¸…ç©ºçŠ¶æ€æ¶ˆæ¯
      setTimeout(() => {
        importStatus.textContent = '';
      }, 3000);
    }, 500);
    
  } catch (error) {
    console.error('æ¸…ç©ºå­¦ç”Ÿå¤±è´¥:', error);
    importStatus.textContent = `âŒ æ¸…ç©ºå¤±è´¥: ${error.message}`;
    importStatus.style.color = '#dc3545';
    statusMsg.innerHTML = '<span class="error">âœ— æ¸…ç©ºå¤±è´¥: ' + error.message + '</span>';
  }
}

// ç›‘å¬è¾“å…¥æ¡†å›è½¦äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('studentName');
  if (input) {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        addStudent();
      }
    });
  }
});
</script>

</body>
</html>
