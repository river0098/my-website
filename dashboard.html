<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ•™å¸ˆç«¯ - å…¨å‘˜å­¦ä¹ æ¦‚è§ˆ</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.6.0/cloudbase.full.js"></script>
<style>
  :root {
    --primary: #6653ff;
    --success: #2fb173;
    --danger: #f26c6c;
    --warning: #ff8f6b;
    --surface: rgba(255,255,255,0.95);
    --text: #1f2749;
    --muted: #6d7691;
  }
  
  * { box-sizing: border-box; }
  
  body {
    font-family: "Segoe UI", Arial, "Microsoft YaHei";
    margin: 0;
    padding: 20px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    min-height: 100vh;
  }
  
  .dashboard-header {
    background: var(--surface);
    padding: 20px 30px;
    border-radius: 16px;
    margin-bottom: 20px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .dashboard-header h1 {
    margin: 0;
    color: var(--text);
  }
  
  .back-link {
    background: var(--primary);
    color: white;
    padding: 10px 20px;
    border-radius: 8px;
    text-decoration: none;
    transition: transform 0.2s;
  }
  
  .back-link:hover {
    transform: translateY(-2px);
  }
  
  .filters {
    background: var(--surface);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 20px;
    display: flex;
    gap: 15px;
    flex-wrap: wrap;
    align-items: center;
  }
  
  .filter-item {
    display: flex;
    flex-direction: column;
    gap: 5px;
  }
  
  .filter-item label {
    font-size: 12px;
    color: var(--muted);
    font-weight: 600;
  }
  
  .filter-item select,
  .filter-item input {
    padding: 8px 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-size: 14px;
  }
  
  button {
    background: var(--primary);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.2s;
  }
  
  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 83, 255, 0.3);
  }
  
  .stats-container {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: 20px;
    margin-bottom: 30px;
  }
  
  .stat-card {
    background: var(--surface);
    padding: 20px;
    border-radius: 16px;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .stat-card h3 {
    margin: 0 0 10px 0;
    color: var(--muted);
    font-size: 14px;
    font-weight: 600;
  }
  
  .stat-value {
    font-size: 32px;
    font-weight: 700;
    color: var(--text);
  }
  
  .stat-label {
    font-size: 12px;
    color: var(--muted);
    margin-top: 5px;
  }
  
  .data-table {
    background: var(--surface);
    border-radius: 16px;
    overflow: hidden;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
  }
  
  .table-header {
    padding: 20px;
    border-bottom: 1px solid #eee;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }
  
  .table-header h2 {
    margin: 0;
    color: var(--text);
    font-size: 18px;
  }
  
  .tab-buttons {
    display: flex;
    gap: 10px;
  }
  
  .tab-button {
    padding: 8px 16px;
    background: transparent;
    color: var(--muted);
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
    transition: all 0.2s;
  }
  
  .tab-button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
  }
  
  th {
    background: #f8f9fa;
    padding: 12px;
    text-align: left;
    font-weight: 600;
    color: var(--muted);
    font-size: 13px;
    border-bottom: 2px solid #eee;
  }
  
  td {
    padding: 12px;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
    color: var(--text);
  }
  
  tbody tr:hover {
    background: #f8f9fa;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 8px;
    border-radius: 4px;
    font-size: 12px;
    font-weight: 600;
  }
  
  .badge-success {
    background: rgba(47, 177, 115, 0.1);
    color: var(--success);
  }
  
  .badge-danger {
    background: rgba(242, 108, 108, 0.1);
    color: var(--danger);
  }
  
  .badge-warning {
    background: rgba(255, 143, 107, 0.1);
    color: var(--warning);
  }
  
  .loading {
    text-align: center;
    padding: 40px;
    color: var(--muted);
  }
  
  .pagination {
    display: flex;
    justify-content: center;
    gap: 10px;
    padding: 20px;
  }
  
  .page-button {
    padding: 8px 12px;
    background: white;
    color: var(--text);
    border: 1px solid #ddd;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }
  
  .page-button.active {
    background: var(--primary);
    color: white;
    border-color: var(--primary);
  }
  
  .export-buttons {
    display: flex;
    gap: 10px;
  }
  
  .export-button {
    padding: 8px 16px;
    background: var(--success);
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    font-size: 14px;
  }

  .error-message {
    background: rgba(242, 108, 108, 0.1);
    color: var(--danger);
    padding: 15px;
    border-radius: 8px;
    margin: 20px 0;
    text-align: center;
  }
</style>
</head>
<body>

<div class="dashboard-header">
  <h1>ğŸ“Š å…¨å‘˜å­¦ä¹ æ•°æ®æ¦‚è§ˆ</h1>
  <a href="index.html" class="back-link">è¿”å›ç»ƒä¹ ç³»ç»Ÿ</a>
</div>

<div class="filters">
  <div class="filter-item">
    <label>å­¦ç”Ÿç­›é€‰</label>
    <select id="studentFilter">
      <option value="">å…¨éƒ¨å­¦ç”Ÿ</option>
    </select>
  </div>
  <div class="filter-item">
    <label>ç»ƒä¹ ç±»å‹</label>
    <select id="typeFilter">
      <option value="">å…¨éƒ¨ç±»å‹</option>
      <option value="word">å•è¯ç»ƒä¹ </option>
      <option value="grammar">è¯­æ³•ç»ƒä¹ </option>
      <option value="sentence">å¥å­é‡ç»„</option>
    </select>
  </div>
  <div class="filter-item">
    <label>å¼€å§‹æ—¥æœŸ</label>
    <input type="date" id="startDate">
  </div>
  <div class="filter-item">
    <label>ç»“æŸæ—¥æœŸ</label>
    <input type="date" id="endDate">
  </div>
  <button onclick="refreshData()">ğŸ”„ åˆ·æ–°æ•°æ®</button>
  <button onclick="exportToCSV()" class="export-button">ğŸ“¥ å¯¼å‡ºCSV</button>
</div>

<div class="stats-container">
  <div class="stat-card">
    <h3>æ€»ç­”é¢˜æ¬¡æ•°</h3>
    <div class="stat-value" id="totalSubmissions">-</div>
    <div class="stat-label">ç´¯è®¡ç­”é¢˜</div>
  </div>
  <div class="stat-card">
    <h3>å¹³å‡æ­£ç¡®ç‡</h3>
    <div class="stat-value" id="avgAccuracy">-</div>
    <div class="stat-label">å…¨å‘˜å¹³å‡</div>
  </div>
  <div class="stat-card">
    <h3>æ´»è·ƒå­¦ç”Ÿ</h3>
    <div class="stat-value" id="activeStudents">-</div>
    <div class="stat-label">ä»Šæ—¥æ´»è·ƒ</div>
  </div>
  <div class="stat-card">
    <h3>æœ€é«˜ç§¯åˆ†</h3>
    <div class="stat-value" id="topScore">-</div>
    <div class="stat-label" id="topScorer">-</div>
  </div>
</div>

<div class="data-table">
  <div class="table-header">
    <h2>è¯¦ç»†æ•°æ®</h2>
    <div class="tab-buttons">
      <button class="tab-button active" onclick="switchTab('students')">å­¦ç”Ÿæ’è¡Œ</button>
      <button class="tab-button" onclick="switchTab('recent')">æœ€è¿‘ç­”é¢˜</button>
      <button class="tab-button" onclick="switchTab('analysis')">é”™é¢˜åˆ†æ</button>
    </div>
  </div>
  
  <div id="studentsTab" class="tab-content">
    <table>
      <thead>
        <tr>
          <th>æ’å</th>
          <th>å­¦ç”Ÿå§“å</th>
          <th>æ€»ç§¯åˆ†</th>
          <th>ç­”é¢˜æ¬¡æ•°</th>
          <th>æ­£ç¡®ç‡</th>
          <th>å•è¯è¿›åº¦</th>
          <th>è¯­æ³•è¿›åº¦</th>
          <th>å¥å­è¿›åº¦</th>
          <th>æœ€åæ´»è·ƒ</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody">
        <tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div id="recentTab" class="tab-content" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>æ—¶é—´</th>
          <th>å­¦ç”Ÿ</th>
          <th>ç±»å‹</th>
          <th>é¢˜ç›®</th>
          <th>ç­”æ¡ˆ</th>
          <th>ç»“æœ</th>
          <th>ç”¨æ—¶</th>
        </tr>
      </thead>
      <tbody id="recentTableBody">
        <tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
  
  <div id="analysisTab" class="tab-content" style="display:none;">
    <table>
      <thead>
        <tr>
          <th>é¢˜ç›®/å•è¯</th>
          <th>é”™è¯¯æ¬¡æ•°</th>
          <th>é”™è¯¯ç‡</th>
          <th>æ¶‰åŠå­¦ç”Ÿ</th>
          <th>å¸¸è§é”™è¯¯</th>
        </tr>
      </thead>
      <tbody id="analysisTableBody">
        <tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div class="pagination" id="pagination"></div>

<script>
// CloudBase åˆå§‹åŒ–
let cloudConnected = false;
let app, db;

try {
  app = cloudbase.init({
    env: "cloud1-8gxc5t0wed3aa3e2"
  });
  db = app.database();
  cloudConnected = true;
  console.log('âœ… CloudBase è¿æ¥æˆåŠŸ');
} catch(err) {
  console.error('âŒ CloudBase è¿æ¥å¤±è´¥:', err);
  document.body.innerHTML = '<div class="error-message">CloudBase è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥å’Œé…ç½®</div>' + document.body.innerHTML;
}

// å­¦ç”Ÿåˆ—è¡¨ï¼ˆä¸ä¸»é¡µé¢ä¿æŒä¸€è‡´ï¼‰
const students = [
  "ç„¦è‰¯ç‘¾","åº„ä¼˜å²³","æ›¾åª›åª›","é™ˆä¼Ÿèª‰","æç…œæ–‡","å´æ²›å®œ","ç‹æ³½éœ–","å´è‹‘èŒ¹","é™ˆä½³ç³—","é»„é’°è¹",
  "åˆ˜æ–‡é”‹","æ¨æ·³å¥½","åˆ˜æ¬£","æ¢é¸¿æµ©","æ¨æ˜ æ˜¥","ç”˜ç´«æ¸Š","é»„ä¹¦æ…§","è°­é“–æ·‡","å¶è•™ä»ª","ç‹è¯—æ¶µ",
  "è°¢å®¶é“„","å¼ è‚²ä¸œ","ä½™ä¹æ¬¢","ä½™æ¬£è¹","ä½•åšç®","æè¥„","æ›¹æ·‘æ€¡","ç‹é¦¨æ€¡","å¶æ€ç¿°"
];

// å¡«å……å­¦ç”Ÿç­›é€‰ä¸‹æ‹‰æ¡†
const studentFilter = document.getElementById('studentFilter');
students.forEach(name => {
  const option = document.createElement('option');
  option.value = name;
  option.textContent = name;
  studentFilter.appendChild(option);
});

// è®¾ç½®é»˜è®¤æ—¥æœŸèŒƒå›´ï¼ˆæœ€è¿‘7å¤©ï¼‰
const endDate = new Date();
const startDate = new Date();
startDate.setDate(startDate.getDate() - 7);
document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
document.getElementById('endDate').value = endDate.toISOString().split('T')[0];

// å…¨å±€æ•°æ®å­˜å‚¨
let currentData = {
  students: [],
  recent: [],
  analysis: []
};

// åˆ‡æ¢æ ‡ç­¾é¡µ
function switchTab(tabName) {
  // æ›´æ–°æŒ‰é’®çŠ¶æ€
  document.querySelectorAll('.tab-button').forEach(btn => {
    btn.classList.remove('active');
  });
  event.target.classList.add('active');
  
  // æ˜¾ç¤ºå¯¹åº”å†…å®¹
  document.querySelectorAll('.tab-content').forEach(content => {
    content.style.display = 'none';
  });
  document.getElementById(tabName + 'Tab').style.display = 'block';
  
  // åŠ è½½å¯¹åº”æ•°æ®
  if(tabName === 'students') loadStudentsData();
  else if(tabName === 'recent') loadRecentData();
  else if(tabName === 'analysis') loadAnalysisData();
}

// åˆ·æ–°æ•°æ®
async function refreshData() {
  if (!cloudConnected) {
    alert('CloudBase æœªè¿æ¥ï¼Œæ— æ³•åˆ·æ–°æ•°æ®');
    return;
  }
  
  await Promise.all([
    loadOverallStats(),
    loadStudentsData()
  ]);
}

// åŠ è½½æ•´ä½“ç»Ÿè®¡
async function loadOverallStats() {
  if (!cloudConnected) return;
  
  try {
    const studentName = document.getElementById('studentFilter').value;
    const type = document.getElementById('typeFilter').value;
    
    // è·å–æ€»ç­”é¢˜æ¬¡æ•°
    const wordCount = (await db.collection('word_submissions').count()).total || 0;
    const grammarCount = (await db.collection('grammar_submissions').count()).total || 0;
    const sentenceCount = (await db.collection('sentence_submissions').count()).total || 0;
    const totalCount = wordCount + grammarCount + sentenceCount;
    
    document.getElementById('totalSubmissions').textContent = totalCount;
    
    // è·å–å¹³å‡æ­£ç¡®ç‡ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼Œå®é™…éœ€è¦èšåˆæŸ¥è¯¢ï¼‰
    const allSubmissions = [];
    if(!type || type === 'word') {
      const wordData = await db.collection('word_submissions').limit(100).get();
      allSubmissions.push(...(wordData.data || []));
    }
    if(!type || type === 'grammar') {
      const grammarData = await db.collection('grammar_submissions').limit(100).get();
      allSubmissions.push(...(grammarData.data || []));
    }
    if(!type || type === 'sentence') {
      const sentenceData = await db.collection('sentence_submissions').limit(100).get();
      allSubmissions.push(...(sentenceData.data || []));
    }
    
    const correctCount = allSubmissions.filter(s => s.is_correct).length;
    const accuracy = allSubmissions.length ? (correctCount / allSubmissions.length * 100).toFixed(1) : 0;
    document.getElementById('avgAccuracy').textContent = accuracy + '%';
    
    // è·å–ä»Šæ—¥æ´»è·ƒå­¦ç”Ÿæ•°
    const today = new Date();
    today.setHours(0,0,0,0);
    const activeSet = new Set();
    allSubmissions.forEach(s => {
      if(new Date(s.timestamp) >= today) {
        activeSet.add(s.student_name);
      }
    });
    document.getElementById('activeStudents').textContent = activeSet.size;
    
    // è·å–æœ€é«˜ç§¯åˆ†
    const scoreData = await db.collection('score_changes')
      .orderBy('total_score', 'desc')
      .limit(1)
      .get();
    
    if(scoreData.data && scoreData.data.length > 0) {
      const topData = scoreData.data[0];
      document.getElementById('topScore').textContent = topData.total_score || 0;
      document.getElementById('topScorer').textContent = topData.student_name || '-';
    }
    
  } catch(err) {
    console.error('åŠ è½½ç»Ÿè®¡å¤±è´¥:', err);
  }
}

// åŠ è½½å­¦ç”Ÿæ’è¡Œæ•°æ®
async function loadStudentsData() {
  if (!cloudConnected) return;
  
  try {
    const tbody = document.getElementById('studentsTableBody');
    tbody.innerHTML = '<tr><td colspan="9" class="loading">åŠ è½½ä¸­...</td></tr>';
    
    // è·å–æ‰€æœ‰å­¦ç”Ÿçš„ç»Ÿè®¡æ•°æ®
    const studentStats = new Map();
    
    // åˆå§‹åŒ–æ‰€æœ‰å­¦ç”Ÿ
    students.forEach(name => {
      studentStats.set(name, {
        name: name,
        totalScore: 0,
        submissions: 0,
        correct: 0,
        wordProgress: 0,
        grammarProgress: 0,
        sentenceProgress: 0,
        lastActive: null
      });
    });
    
    // ç®€åŒ–ç‰ˆæœ¬çš„æ•°æ®è·å–ï¼ˆå®é™…åº”è¯¥ä½¿ç”¨èšåˆæŸ¥è¯¢ï¼‰
    const scoreData = await db.collection('score_changes').limit(100).get();
    if (scoreData.data) {
      scoreData.data.forEach(record => {
        if(studentStats.has(record.student_name)) {
          const stat = studentStats.get(record.student_name);
          stat.totalScore = Math.max(stat.totalScore, record.total_score || 0);
        }
      });
    }
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    const statsArray = Array.from(studentStats.values())
      .sort((a, b) => b.totalScore - a.totalScore);
    
    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = '';
    statsArray.forEach((stat, index) => {
      const accuracy = stat.submissions ? (stat.correct / stat.submissions * 100).toFixed(1) : 0;
      const lastActiveStr = stat.lastActive 
        ? new Date(stat.lastActive).toLocaleDateString('zh-CN')
        : 'ä»æœª';
      
      const row = `
        <tr>
          <td>${index + 1}</td>
          <td><strong>${stat.name}</strong></td>
          <td><span class="badge badge-warning">${stat.totalScore}</span></td>
          <td>${stat.submissions}</td>
          <td>${accuracy}%</td>
          <td>${stat.wordProgress}</td>
          <td>${stat.grammarProgress}</td>
          <td>${stat.sentenceProgress}</td>
          <td>${lastActiveStr}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    currentData.students = statsArray;
    
  } catch(err) {
    console.error('åŠ è½½å­¦ç”Ÿæ•°æ®å¤±è´¥:', err);
    document.getElementById('studentsTableBody').innerHTML = 
      '<tr><td colspan="9" class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
  }
}

// åŠ è½½æœ€è¿‘ç­”é¢˜è®°å½•
async function loadRecentData() {
  if (!cloudConnected) return;
  
  try {
    const tbody = document.getElementById('recentTableBody');
    tbody.innerHTML = '<tr><td colspan="7" class="loading">åŠ è½½ä¸­...</td></tr>';
    
    // è·å–ç­›é€‰æ¡ä»¶
    const studentName = document.getElementById('studentFilter').value;
    const type = document.getElementById('typeFilter').value;
    
    const recentSubmissions = [];
    
    // è·å–å„ç±»æäº¤è®°å½•ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    if(!type || type === 'word') {
      let query = db.collection('word_submissions');
      if(studentName) query = query.where({student_name: studentName});
      const data = await query.orderBy('timestamp', 'desc').limit(20).get();
      if (data.data) {
        data.data.forEach(item => {
          recentSubmissions.push({
            ...item,
            type: 'å•è¯',
            question: item.word,
            answer: item.user_answer || 'æœªä½œç­”'
          });
        });
      }
    }
    
    // æŒ‰æ—¶é—´æ’åº
    recentSubmissions.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    
    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = '';
    recentSubmissions.slice(0, 50).forEach(item => {
      const time = new Date(item.timestamp).toLocaleString('zh-CN');
      const resultBadge = item.is_correct 
        ? '<span class="badge badge-success">æ­£ç¡®</span>'
        : '<span class="badge badge-danger">é”™è¯¯</span>';
      const timeSpent = item.time_spent || '-';
      
      const row = `
        <tr>
          <td>${time}</td>
          <td>${item.student_name}</td>
          <td>${item.type}</td>
          <td>${item.question}</td>
          <td>${item.answer}</td>
          <td>${resultBadge}</td>
          <td>${timeSpent}ç§’</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    currentData.recent = recentSubmissions;
    
  } catch(err) {
    console.error('åŠ è½½æœ€è¿‘è®°å½•å¤±è´¥:', err);
    document.getElementById('recentTableBody').innerHTML = 
      '<tr><td colspan="7" class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
  }
}

// åŠ è½½é”™é¢˜åˆ†æ
async function loadAnalysisData() {
  if (!cloudConnected) return;
  
  try {
    const tbody = document.getElementById('analysisTableBody');
    tbody.innerHTML = '<tr><td colspan="5" class="loading">åŠ è½½ä¸­...</td></tr>';
    
    const errorAnalysis = new Map();
    
    // åˆ†æå•è¯é”™é¢˜ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
    const wordData = await db.collection('word_submissions')
      .where({is_correct: false})
      .limit(50)
      .get();
    
    if (wordData.data) {
      wordData.data.forEach(item => {
        const key = item.word;
        if(!errorAnalysis.has(key)) {
          errorAnalysis.set(key, {
            question: key,
            type: 'å•è¯',
            errorCount: 0,
            totalCount: 0,
            students: new Set(),
            wrongAnswers: new Map()
          });
        }
        const analysis = errorAnalysis.get(key);
        analysis.errorCount++;
        analysis.students.add(item.student_name);
        
        if(item.user_answer) {
          const count = analysis.wrongAnswers.get(item.user_answer) || 0;
          analysis.wrongAnswers.set(item.user_answer, count + 1);
        }
      });
    }
    
    // è½¬æ¢ä¸ºæ•°ç»„å¹¶æ’åº
    const analysisArray = Array.from(errorAnalysis.values())
      .map(item => ({
        ...item,
        errorRate: item.totalCount ? (item.errorCount / item.totalCount * 100).toFixed(1) : 100,
        studentsList: Array.from(item.students).slice(0, 3).join('ã€'),
        commonErrors: Array.from(item.wrongAnswers.entries())
          .sort((a, b) => b[1] - a[1])
          .slice(0, 2)
          .map(([answer, count]) => `${answer}(${count}æ¬¡)`)
          .join('ã€')
      }))
      .sort((a, b) => b.errorCount - a.errorCount);
    
    // æ¸²æŸ“è¡¨æ ¼
    tbody.innerHTML = '';
    analysisArray.slice(0, 30).forEach(item => {
      const row = `
        <tr>
          <td>${item.question}</td>
          <td><span class="badge badge-danger">${item.errorCount}</span></td>
          <td>${item.errorRate}%</td>
          <td>${item.studentsList}${item.students.size > 3 ? 'ç­‰' : ''}</td>
          <td>${item.commonErrors || '-'}</td>
        </tr>
      `;
      tbody.innerHTML += row;
    });
    
    currentData.analysis = analysisArray;
    
  } catch(err) {
    console.error('åŠ è½½é”™é¢˜åˆ†æå¤±è´¥:', err);
    document.getElementById('analysisTableBody').innerHTML = 
      '<tr><td colspan="5" class="loading">åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</td></tr>';
  }
}

// å¯¼å‡ºCSV
function exportToCSV() {
  const activeTab = document.querySelector('.tab-button.active').textContent;
  let csvContent = '';
  let filename = '';
  
  if(activeTab === 'å­¦ç”Ÿæ’è¡Œ') {
    csvContent = 'æ’å,å­¦ç”Ÿå§“å,æ€»ç§¯åˆ†,ç­”é¢˜æ¬¡æ•°,æ­£ç¡®ç‡,å•è¯è¿›åº¦,è¯­æ³•è¿›åº¦,å¥å­è¿›åº¦,æœ€åæ´»è·ƒ\n';
    currentData.students.forEach((stat, index) => {
      const accuracy = stat.submissions ? (stat.correct / stat.submissions * 100).toFixed(1) : 0;
      const lastActive = stat.lastActive ? new Date(stat.lastActive).toLocaleDateString('zh-CN') : 'ä»æœª';
      csvContent += `${index + 1},${stat.name},${stat.totalScore},${stat.submissions},${accuracy}%,${stat.wordProgress},${stat.grammarProgress},${stat.sentenceProgress},${lastActive}\n`;
    });
    filename = `å­¦ç”Ÿæ’è¡Œ_${new Date().toLocaleDateString('zh-CN')}.csv`;
  } else if(activeTab === 'æœ€è¿‘ç­”é¢˜') {
    csvContent = 'æ—¶é—´,å­¦ç”Ÿ,ç±»å‹,é¢˜ç›®,ç­”æ¡ˆ,ç»“æœ,ç”¨æ—¶\n';
    currentData.recent.forEach(item => {
      const time = new Date(item.timestamp).toLocaleString('zh-CN');
      const result = item.is_correct ? 'æ­£ç¡®' : 'é”™è¯¯';
      const timeSpent = item.time_spent || '-';
      csvContent += `${time},${item.student_name},${item.type},"${item.question}","${item.answer}",${result},${timeSpent}\n`;
    });
    filename = `æœ€è¿‘ç­”é¢˜_${new Date().toLocaleDateString('zh-CN')}.csv`;
  } else if(activeTab === 'é”™é¢˜åˆ†æ') {
    csvContent = 'é¢˜ç›®,é”™è¯¯æ¬¡æ•°,é”™è¯¯ç‡,æ¶‰åŠå­¦ç”Ÿ,å¸¸è§é”™è¯¯\n';
    currentData.analysis.forEach(item => {
      csvContent += `"${item.question}",${item.errorCount},${item.errorRate}%,"${item.studentsList}","${item.commonErrors}"\n`;
    });
    filename = `é”™é¢˜åˆ†æ_${new Date().toLocaleDateString('zh-CN')}.csv`;
  }
  
  // æ·»åŠ BOMä»¥æ”¯æŒä¸­æ–‡
  const BOM = '\uFEFF';
  const blob = new Blob([BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
  const link = document.createElement('a');
  const url = URL.createObjectURL(blob);
  link.setAttribute('href', url);
  link.setAttribute('download', filename);
  link.style.visibility = 'hidden';
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
window.onload = () => {
  if (cloudConnected) {
    refreshData();
  }
};

// å®šæ—¶åˆ·æ–°ï¼ˆæ¯60ç§’ï¼‰
if (cloudConnected) {
  setInterval(refreshData, 60000);
}
</script>

</body>
</html>