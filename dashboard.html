<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>æ•™å¸ˆç«¯ Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- è…¾è®¯äº‘ CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f9faff;color:#1f2749}
  header{background:#333;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  input,button{padding:10px 14px;margin:5px;border-radius:6px;border:1px solid #ced4da;font-size:14px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  ul{list-style:none;padding:0;margin-top:20px}
  li{padding:12px;border:1px solid #e9ecef;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;background:#fff;transition:all 0.3s ease}
  li:hover{background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px}
  .delete-btn:hover{background:#c82333}
  .student-name{font-size:16px;color:#495057}
  .empty-state{text-align:center;padding:40px;color:#6c757d}
  .loading{text-align:center;padding:20px;color:#6c757d}
  .student-count{background:#e7f3ff;color:#0066cc;padding:5px 10px;border-radius:4px;font-size:14px}
</style>
</head>
<body>
<header>
  <h1>æ•™å¸ˆç«¯ Dashboard</h1>
  <nav>
    <a href="index.html">å­¦ç”Ÿç«¯</a> | 
    <a href="dashboard.html">æ•™å¸ˆç«¯</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>ç³»ç»ŸçŠ¶æ€</h3>
    <div id="statusMsg">æ­£åœ¨åˆå§‹åŒ–...</div>
  </div>
  
  <div class="status-box">
    <h3>æ·»åŠ å­¦ç”Ÿ</h3>
    <div style="display:flex;align-items:center">
      <input type="text" id="studentName" placeholder="è¾“å…¥å­¦ç”Ÿå§“å" style="flex:1">
      <button onclick="addStudent()">æ·»åŠ å­¦ç”Ÿ</button>
      <button onclick="loadStudents()" style="background:#28a745">åˆ·æ–°åˆ—è¡¨</button>
    </div>
  </div>
  
  <div id="listContainer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>å­¦ç”Ÿåˆ—è¡¨</h3>
      <span id="studentCount" class="student-count">å…± 0 ä¸ªå­¦ç”Ÿ</span>
    </div>
    <ul id="studentList">
      <li class="loading">æ­£åœ¨åŠ è½½å­¦ç”Ÿæ•°æ®...</li>
    </ul>
  </div>
  
  <div class="status-box" style="background:#fff3cd;border-left:4px solid #ffc107">
    <h4>æç¤º</h4>
    <p>â€¢ æ·»åŠ å­¦ç”Ÿåï¼Œæ•°æ®ä¼šè‡ªåŠ¨ä¿å­˜åˆ°è…¾è®¯äº‘æ•°æ®åº“</p>
    <p>â€¢ å­¦ç”Ÿç«¯ä¼šè‡ªåŠ¨è¯»å–è¿™é‡Œæ·»åŠ çš„å­¦ç”Ÿæ•°æ®</p>
    <p>â€¢ æ•°æ®ä¼šåœ¨é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆ·æ–°</p>
  </div>
</main>

<script>
// å…¨å±€å˜é‡
let app = null;
let auth = null;
let db = null;

// é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
window.addEventListener('DOMContentLoaded', function() {
  console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');
  setTimeout(initApp, 500);
});

// åˆå§‹åŒ–åº”ç”¨
async function initApp() {
  const statusMsg = document.getElementById('statusMsg');
  
  // æ£€æŸ¥SDK
  if (typeof cloudbase === 'undefined') {
    statusMsg.innerHTML = '<span class="error">âœ— SDK æœªåŠ è½½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥</span>';
    return;
  }
  
  statusMsg.innerHTML = '<span class="success">âœ“ SDK å·²åŠ è½½</span>';
  console.log('SDKå·²åŠ è½½');
  
  try {
    // åˆå§‹åŒ–CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // è®¾ç½®è®¤è¯
    auth = app.auth({
      persistence: 'local'
    });
    
    // è·å–æ•°æ®åº“å¼•ç”¨
    db = app.database();
    
    statusMsg.innerHTML = '<span class="success">âœ“ äº‘å¼€å‘å·²åˆå§‹åŒ–</span>';
    console.log('CloudBaseåˆå§‹åŒ–æˆåŠŸ');
    
    // ç¡®ä¿ç™»å½•
    const loginSuccess = await ensureLogin();
    
    if (loginSuccess) {
      // è‡ªåŠ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨
      console.log('å¼€å§‹è‡ªåŠ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨...');
      await loadStudents();
      
      // æ¯30ç§’è‡ªåŠ¨åˆ·æ–°ä¸€æ¬¡
      setInterval(loadStudents, 30000);
    }
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— åˆå§‹åŒ–å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆå§‹åŒ–å¤±è´¥:', error);
  }
}

// ç¡®ä¿ç™»å½•
async function ensureLogin() {
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      console.log('å¼€å§‹åŒ¿åç™»å½•...');
      statusMsg.innerHTML = '<span class="info">æ­£åœ¨è¿›è¡ŒåŒ¿åç™»å½•...</span>';
      await auth.anonymousAuthProvider().signIn();
      statusMsg.innerHTML = '<span class="success">âœ“ åŒ¿åç™»å½•æˆåŠŸ</span>';
      console.log('åŒ¿åç™»å½•æˆåŠŸ');
    } else {
      statusMsg.innerHTML = '<span class="success">âœ“ å·²ç™»å½•</span>';
      console.log('å·²æœ‰ç™»å½•çŠ¶æ€');
    }
    
    return true;
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— ç™»å½•å¤±è´¥: ' + error.message + '</span>';
    console.error('ç™»å½•å¤±è´¥:', error);
    return false;
  }
}

// åŠ è½½å­¦ç”Ÿåˆ—è¡¨ï¼ˆä¼šè‡ªåŠ¨è°ƒç”¨ï¼‰
async function loadStudents() {
  const list = document.getElementById('studentList');
  const statusMsg = document.getElementById('statusMsg');
  const countSpan = document.getElementById('studentCount');
  
  console.log('æ­£åœ¨åŠ è½½å­¦ç”Ÿåˆ—è¡¨...');
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      console.log('æœªç™»å½•ï¼Œæ— æ³•åŠ è½½æ•°æ®');
      return;
    }
    
    // æ˜¾ç¤ºåŠ è½½ä¸­
    if (list.children.length === 0 || list.querySelector('.empty-state')) {
      list.innerHTML = '<li class="loading">æ­£åœ¨åŠ è½½æ•°æ®...</li>';
    }
    
    // è¯»å–å­¦ç”Ÿæ•°æ®
    console.log('å¼€å§‹è¯»å–studentsé›†åˆ...');
    const res = await db.collection('students').get();
    console.log('æŸ¥è¯¢ç»“æœ:', res);
    
    // æ¸…ç©ºåˆ—è¡¨
    list.innerHTML = '';
    
    if (!res.data || res.data.length === 0) {
      list.innerHTML = '<li class="empty-state">æš‚æ— å­¦ç”Ÿæ•°æ®ï¼Œè¯·ç‚¹å‡»ä¸Šæ–¹"æ·»åŠ å­¦ç”Ÿ"æŒ‰é’®æ·»åŠ </li>';
      statusMsg.innerHTML = '<span class="warning">æš‚æ— å­¦ç”Ÿæ•°æ®</span>';
      countSpan.textContent = 'å…± 0 ä¸ªå­¦ç”Ÿ';
      console.log('æ•°æ®åº“ä¸­æš‚æ— å­¦ç”Ÿ');
      return;
    }
    
    // æŒ‰å§“åæ’åº
    const sortedData = res.data.sort((a, b) => {
      return (a.name || '').localeCompare(b.name || '', 'zh-CN');
    });
    
    // æ˜¾ç¤ºå­¦ç”Ÿåˆ—è¡¨
    console.log(`æ‰¾åˆ° ${sortedData.length} ä¸ªå­¦ç”Ÿ`);
    sortedData.forEach((student, index) => {
      const li = document.createElement('li');
      li.style.animationDelay = (index * 0.1) + 's';
      li.innerHTML = `
        <span class="student-name">ğŸ“š ${student.name}</span>
        <button class="delete-btn" onclick="deleteStudent('${student._id}')">åˆ é™¤</button>
      `;
      list.appendChild(li);
    });
    
    statusMsg.innerHTML = '<span class="success">âœ“ å·²åŠ è½½ ' + sortedData.length + ' ä¸ªå­¦ç”Ÿ</span>';
    countSpan.textContent = 'å…± ' + sortedData.length + ' ä¸ªå­¦ç”Ÿ';
    console.log('å­¦ç”Ÿåˆ—è¡¨åŠ è½½å®Œæˆ');
    
  } catch (error) {
    list.innerHTML = '<li class="empty-state">åŠ è½½å¤±è´¥: ' + error.message + '</li>';
    statusMsg.innerHTML = '<span class="error">âœ— åŠ è½½å¤±è´¥: ' + error.message + '</span>';
    countSpan.textContent = 'åŠ è½½å¤±è´¥';
    console.error('åŠ è½½å­¦ç”Ÿå¤±è´¥:', error);
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      statusMsg.innerHTML += '<br><span class="warning">è¯·æ£€æŸ¥æ•°æ®åº“æƒé™è®¾ç½®</span>';
    }
  }
}

// æ·»åŠ å­¦ç”Ÿ
window.addStudent = async function() {
  const nameInput = document.getElementById('studentName');
  const name = nameInput.value.trim();
  const statusMsg = document.getElementById('statusMsg');
  
  if (!name) {
    alert('è¯·è¾“å…¥å­¦ç”Ÿå§“å');
    nameInput.focus();
    return;
  }
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('æœªç™»å½•ï¼Œè¯·åˆ·æ–°é¡µé¢');
      return;
    }
    
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨æ·»åŠ å­¦ç”Ÿ...</span>';
    console.log('æ­£åœ¨æ·»åŠ å­¦ç”Ÿ:', name);
    
    // æ·»åŠ åˆ°æ•°æ®åº“
    const result = await db.collection('students').add({
      name: name,
      createdAt: new Date().toISOString()
    });
    
    console.log('æ·»åŠ æˆåŠŸï¼Œæ–‡æ¡£ID:', result.id);
    
    // æ¸…ç©ºè¾“å…¥æ¡†
    nameInput.value = '';
    
    // æ˜¾ç¤ºæˆåŠŸæ¶ˆæ¯
    statusMsg.innerHTML = '<span class="success">âœ“ å·²æˆåŠŸæ·»åŠ å­¦ç”Ÿ: ' + name + '</span>';
    
    // è‡ªåŠ¨é‡æ–°åŠ è½½åˆ—è¡¨
    setTimeout(() => {
      loadStudents();
    }, 500);
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— æ·»åŠ å¤±è´¥: ' + error.message + '</span>';
    console.error('æ·»åŠ å­¦ç”Ÿå¤±è´¥:', error);
    alert('æ·»åŠ å¤±è´¥: ' + error.message);
  }
}

// åˆ é™¤å­¦ç”Ÿ
window.deleteStudent = async function(id) {
  if (!confirm('ç¡®å®šè¦åˆ é™¤è¯¥å­¦ç”Ÿå—ï¼Ÿåˆ é™¤åæ— æ³•æ¢å¤ã€‚')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  
  if (!db) {
    alert('ç³»ç»Ÿæœªåˆå§‹åŒ–ï¼Œè¯·åˆ·æ–°é¡µé¢');
    return;
  }
  
  try {
    // ç¡®ä¿å·²ç™»å½•
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('æœªç™»å½•ï¼Œè¯·åˆ·æ–°é¡µé¢');
      return;
    }
    
    statusMsg.innerHTML = '<span class="info">æ­£åœ¨åˆ é™¤...</span>';
    console.log('æ­£åœ¨åˆ é™¤å­¦ç”Ÿï¼ŒID:', id);
    
    // ä»æ•°æ®åº“åˆ é™¤
    await db.collection('students').doc(id).remove();
    
    console.log('åˆ é™¤æˆåŠŸ');
    statusMsg.innerHTML = '<span class="success">âœ“ å·²åˆ é™¤å­¦ç”Ÿ</span>';
    
    // è‡ªåŠ¨é‡æ–°åŠ è½½åˆ—è¡¨
    setTimeout(() => {
      loadStudents();
    }, 500);
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">âœ— åˆ é™¤å¤±è´¥: ' + error.message + '</span>';
    console.error('åˆ é™¤å­¦ç”Ÿå¤±è´¥:', error);
    alert('åˆ é™¤å¤±è´¥: ' + error.message);
  }
}

// ç›‘å¬è¾“å…¥æ¡†å›è½¦äº‹ä»¶
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('studentName');
  if (input) {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        addStudent();
      }
    });
  }
});
</script>

</body>
</html>