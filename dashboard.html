<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<title>教师端 Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- 腾讯云 CloudBase SDK -->
<script src="https://imgcache.qq.com/qcloud/cloudbase-js-sdk/1.5.0/cloudbase.full.js"></script>
<script src="student_data.js"></script>

<style>
  body{font-family:"Microsoft YaHei",Arial;margin:0;background:#f9faff;color:#1f2749}
  header{background:#333;color:#fff;padding:20px;text-align:center}
  nav{margin-top:10px}
  nav a{color:#fff;text-decoration:none;margin:0 8px}
  nav a:hover{text-decoration:underline}
  main{max-width:880px;margin:20px auto;background:#fff;padding:20px;border-radius:12px;box-shadow:0 4px 12px rgba(0,0,0,0.1)}
  .status-box{background:#f8f9fa;padding:15px;border-radius:8px;margin:15px 0}
  .success{color:#28a745;font-weight:bold}
  .error{color:#dc3545;font-weight:bold}
  .warning{color:#ffc107;font-weight:bold}
  .info{color:#17a2b8}
  input,button{padding:10px 14px;margin:5px;border-radius:6px;border:1px solid #ced4da;font-size:14px}
  button{background:#6653ff;color:#fff;border:none;cursor:pointer}
  button:hover{background:#4a3dd9}
  ul{list-style:none;padding:0;margin-top:20px}
  li{padding:12px;border:1px solid #e9ecef;margin:8px 0;border-radius:6px;display:flex;justify-content:space-between;align-items:center;background:#fff;transition:all 0.3s ease;cursor:pointer}
  li:hover{background:#f8f9fa;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
  .delete-btn{background:#dc3545;color:#fff;border:none;padding:6px 12px;border-radius:4px;cursor:pointer;font-size:12px}
  .delete-btn:hover{background:#c82333}
  .student-name{font-size:16px;color:#495057}
  .empty-state{text-align:center;padding:40px;color:#6c757d;cursor:default}
  .loading{text-align:center;padding:20px;color:#6c757d}
  .student-count{background:#e7f3ff;color:#0066cc;padding:5px 10px;border-radius:4px;font-size:14px}
  .student-list-hint{font-size:12px;color:#6c757d;margin-top:6px}
  .analytic-chart{margin-top:12px}
  .bar-row{display:flex;align-items:center;margin:6px 0}
  .bar-label{width:120px;font-size:13px;color:#495057;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
  .bar-track{flex:1;height:12px;background:#e9ecef;border-radius:999px;margin:0 10px;position:relative;overflow:hidden}
  .bar-fill{height:100%;background:linear-gradient(90deg,#6653ff,#4a3dd9);border-radius:999px}
  .bar-value{font-size:12px;color:#333;font-weight:bold}
  .detail-box{margin-top:20px;padding:15px;border:1px solid #e9ecef;border-radius:8px;background:#fff}
  .detail-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
  .detail-title{font-size:18px;margin:0;color:#333}
  .detail-close{background:none;border:none;font-size:20px;cursor:pointer;color:#999}
  .detail-close:hover{color:#333}
  .summary-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:15px 0}
  .summary-card{padding:12px;border-radius:8px;background:#f8f9ff;border:1px solid #e3e7ff;text-align:center}
  .summary-label{font-size:12px;color:#6c757d}
  .summary-number{font-size:20px;font-weight:bold;color:#4a3dd9;margin-top:4px}
  .log-table{width:100%;border-collapse:collapse;margin-top:10px}
  .log-table th,.log-table td{border:1px solid #e9ecef;padding:8px;font-size:12px;text-align:center}
  .log-table th{background:#f1f3f5;color:#495057}
  .log-empty{padding:20px;text-align:center;color:#6c757d;font-size:13px}
</style>
</head>
<body>
<header>
  <h1>教师端 Dashboard</h1>
  <nav>
    <a href="index.html">学生端</a> | 
    <a href="dashboard.html">教师端</a>
  </nav>
</header>

<main>
  <div class="status-box">
    <h3>系统状态</h3>
    <div id="statusMsg">正在初始化...</div>
  </div>
  
  <div class="status-box">
    <h3>添加学生</h3>
    <div style="display:flex;align-items:center;margin-bottom:15px">
      <input type="text" id="studentName" placeholder="输入学生姓名" style="flex:1">
      <button onclick="addStudent()">添加学生</button>
      <button onclick="loadStudents()" style="background:#28a745">刷新列表</button>
    </div>
  </div>
  
  <div class="status-box" style="background:#f8f9ff;border:2px solid #6653ff;border-radius:12px">
    <h3 style="color:#6653ff;margin-top:0">📚 班级学生管理</h3>
    <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin-bottom:15px">
      <div style="padding:15px;background:#fff;border-radius:8px;border:1px solid #e9ecef">
        <h4 id="class31Title" style="color:#495057;margin-top:0;margin-bottom:10px"></h4>
        <div id="class31Names" style="font-size:13px;color:#6c757d;margin-bottom:10px"></div>
        <button onclick="importClass31Students()" style="background:#28a745;width:100%">
          📥 导入31班学生
        </button>
      </div>
      <div style="padding:15px;background:#fff;border-radius:8px;border:1px solid #e9ecef">
        <h4 id="class39Title" style="color:#495057;margin-top:0;margin-bottom:10px"></h4>
        <div id="class39Names" style="font-size:13px;color:#6c757d;margin-bottom:10px"></div>
        <button onclick="importClass39Students()" style="background:#17a2b8;width:100%">
          📥 导入39班学生
        </button>
      </div>
    </div>
    <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap">
      <button id="importAllButton" onclick="importAllStudents()" style="background:#ffc107;color:#000;font-weight:bold">
        📥 导入所有学生
      </button>
      <button onclick="clearAllStudents()" style="background:#dc3545">
        🗑️ 清空所有学生
      </button>
      <span id="importStatus" style="color:#6c757d;font-size:13px"></span>
    </div>
    <div style="margin-top:10px;padding:8px;background:#e7f3ff;border-radius:6px;font-size:13px;color:#0066cc">
      💡 提示：点击相应按钮可导入对应班级的学生，或一次性导入所有学生
    </div>
  </div>
  
  <div class="status-box">
    <h3>📊 学生练习概览</h3>
    <div id="practiceChart" class="analytic-chart"></div>
    <div class="student-list-hint">提示：图表展示练习题目数量排名靠前的学生，点击下方学生姓名可查看详细记录。</div>
  </div>
  
  <div id="listContainer">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <h3>学生列表</h3>
      <span id="studentCount" class="student-count">共 0 个学生</span>
    </div>
    <ul id="studentList">
      <li class="loading">正在加载学生数据...</li>
    </ul>
  </div>
  
  <div id="studentDetail" class="detail-box" style="display:none">
    <div class="detail-header">
      <h3 id="detailTitle" class="detail-title">学生练习详情</h3>
      <button class="detail-close" onclick="hideStudentDetail()">×</button>
    </div>
    <div id="detailContent">请选择一位学生查看练习数据</div>
  </div>
  
  <div class="status-box" style="background:#fff3cd;border-left:4px solid #ffc107">
    <h4>提示</h4>
    <p>• 添加学生后，数据会自动保存到腾讯云数据库</p>
    <p>• 学生端会自动读取这里添加的学生数据</p>
    <p>• 数据会在页面加载时自动刷新</p>
  </div>
</main>

<script>
// 全局变量
let app = null;
let auth = null;
let db = null;
const practiceDataStore = {};
const practiceChartEl = document.getElementById('practiceChart');
const detailBox = document.getElementById('studentDetail');
const detailTitle = document.getElementById('detailTitle');
const detailContent = document.getElementById('detailContent');

if (practiceChartEl) {
  practiceChartEl.innerHTML = '<div class="log-empty">等待加载学生数据...</div>';
}

function seededRandom(seed) {
  let value = seed % 2147483647;
  if (value <= 0) value += 2147483646;
  return function() {
    value = value * 16807 % 2147483647;
    return (value - 1) / 2147483646;
  };
}

function hashString(str) {
  let hash = 0;
  for (let i = 0; i < str.length; i++) {
    hash = (hash << 5) - hash + str.charCodeAt(i);
    hash |= 0;
  }
  return Math.abs(hash) + 1;
}

function generatePracticeData(name, className) {
  const seed = hashString(`${name}-${className}`);
  const random = seededRandom(seed);
  const sessionCount = 4 + Math.floor(random() * 6);
  const logs = [];
  let totalQuestions = 0;
  let totalCorrect = 0;
  let totalMinutes = 0;
  const datasetPool = ['词汇冲刺', '高频语法', '完形填空', '阅读理解', '写作素材'];

  for (let i = 0; i < sessionCount; i++) {
    const questions = 15 + Math.floor(random() * 15);
    const accuracy = 0.6 + random() * 0.35;
    const correct = Math.round(questions * accuracy);
    const duration = 8 + Math.floor(random() * 12);
    const dataset = datasetPool[Math.floor(random() * datasetPool.length)];
    const timestamp = new Date(Date.now() - (i * (random() * 18 + 6)) * 3600 * 1000);

    totalQuestions += questions;
    totalCorrect += correct;
    totalMinutes += duration;

    logs.push({
      timestamp,
      dataset,
      questions,
      correct,
      accuracy: Math.round((correct / questions) * 100),
      duration
    });
  }

  logs.sort((a, b) => b.timestamp - a.timestamp);

  return {
    name,
    className,
    sessions: sessionCount,
    totalQuestions,
    totalCorrect,
    totalMinutes,
    averageAccuracy: Math.round((totalCorrect / totalQuestions) * 100),
    logs
  };
}

function ensurePracticeData(student) {
  const name = student.name || '未知';
  if (!practiceDataStore[name]) {
    const className = student.class || student.className || '未分班';
    practiceDataStore[name] = generatePracticeData(name, className);
  }
  return practiceDataStore[name];
}

function updatePracticeChart(students) {
  if (!practiceChartEl) return;
  if (!students || !students.length) {
    practiceChartEl.innerHTML = '<div class="log-empty">暂无学生练习数据</div>';
    return;
  }

  const datasets = students.map(student => {
    const data = ensurePracticeData(student);
    return {
      name: student.name || '未知',
      totalQuestions: data.totalQuestions
    };
  });

  datasets.sort((a, b) => b.totalQuestions - a.totalQuestions);
  const top = datasets.slice(0, 8);
  const maxValue = Math.max(...top.map(item => item.totalQuestions), 1);

  practiceChartEl.innerHTML = top.map(item => {
    const percentage = Math.round((item.totalQuestions / maxValue) * 100);
    return `
      <div class="bar-row">
        <span class="bar-label" title="${item.name}">${item.name}</span>
        <div class="bar-track">
          <div class="bar-fill" style="width:${percentage}%"></div>
        </div>
        <span class="bar-value">${item.totalQuestions} 题</span>
      </div>
    `;
  }).join('');
}

function showStudentDetail(student) {
  const data = ensurePracticeData(student);
  if (!detailBox || !detailTitle || !detailContent) return;

  detailTitle.textContent = `${data.name} · ${data.className}`;

  const summaryHtml = `
    <div class="summary-grid">
      <div class="summary-card">
        <div class="summary-label">练习次数</div>
        <div class="summary-number">${data.sessions}</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">总题量</div>
        <div class="summary-number">${data.totalQuestions}</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">正确率</div>
        <div class="summary-number">${data.averageAccuracy}%</div>
      </div>
      <div class="summary-card">
        <div class="summary-label">累计用时</div>
        <div class="summary-number">${data.totalMinutes} 分钟</div>
      </div>
    </div>
  `;

  const logsHtml = data.logs.length ? `
    <table class="log-table">
      <thead>
        <tr>
          <th>练习时间</th>
          <th>题库</th>
          <th>题量</th>
          <th>正确数</th>
          <th>正确率</th>
          <th>用时</th>
        </tr>
      </thead>
      <tbody>
        ${data.logs.map(log => `
          <tr>
            <td>${log.timestamp.toLocaleString()}</td>
            <td>${log.dataset}</td>
            <td>${log.questions}</td>
            <td>${log.correct}</td>
            <td>${log.accuracy}%</td>
            <td>${log.duration} 分钟</td>
          </tr>
        `).join('')}
      </tbody>
    </table>
  ` : '<div class="log-empty">暂无练习记录</div>';

  detailContent.innerHTML = summaryHtml + logsHtml;
  detailBox.style.display = 'block';
}

function hideStudentDetail() {
  if (detailBox) {
    detailBox.style.display = 'none';
    if (detailTitle) {
      detailTitle.textContent = '学生练习详情';
    }
    if (detailContent) {
      detailContent.innerHTML = '请选择一位学生查看练习数据';
    }
  }
}

// 页面加载完成后初始化
window.addEventListener('DOMContentLoaded', function() {
  console.log('页面加载完成，开始初始化...');
  renderClassCards();
  setTimeout(initApp, 500);
});

// 初始化应用
async function initApp() {
  const statusMsg = document.getElementById('statusMsg');
  
  // 检查SDK
  if (typeof cloudbase === 'undefined') {
    statusMsg.innerHTML = '<span class="error">✗ SDK 未加载，请检查网络连接</span>';
    return;
  }
  
  statusMsg.innerHTML = '<span class="success">✓ SDK 已加载</span>';
  console.log('SDK已加载');
  
  try {
    // 初始化CloudBase
    app = cloudbase.init({
      env: 'cloud1-8gxc5t0wed3aa3e2'
    });
    
    // 设置认证
    auth = app.auth({
      persistence: 'local'
    });
    
    // 获取数据库引用
    db = app.database();
    
    statusMsg.innerHTML = '<span class="success">✓ 云开发已初始化</span>';
    console.log('CloudBase初始化成功');
    
    // 确保登录
    const loginSuccess = await ensureLogin();
    
    if (loginSuccess) {
      // 自动加载学生列表
      console.log('开始自动加载学生列表...');
      await loadStudents();
      
      // 每30秒自动刷新一次
      setInterval(loadStudents, 30000);
    }
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 初始化失败: ' + error.message + '</span>';
    console.error('初始化失败:', error);
  }
}

// 确保登录
async function ensureLogin() {
  const statusMsg = document.getElementById('statusMsg');
  
  try {
    const loginState = await auth.getLoginState();
    
    if (!loginState) {
      console.log('开始匿名登录...');
      statusMsg.innerHTML = '<span class="info">正在进行匿名登录...</span>';
      await auth.anonymousAuthProvider().signIn();
      statusMsg.innerHTML = '<span class="success">✓ 匿名登录成功</span>';
      console.log('匿名登录成功');
    } else {
      statusMsg.innerHTML = '<span class="success">✓ 已登录</span>';
      console.log('已有登录状态');
    }
    
    return true;
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 登录失败: ' + error.message + '</span>';
    console.error('登录失败:', error);
    return false;
  }
}

// 加载学生列表（会自动调用）
async function loadStudents() {
  const list = document.getElementById('studentList');
  const statusMsg = document.getElementById('statusMsg');
  const countSpan = document.getElementById('studentCount');
  
  console.log('正在加载学生列表...');
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      console.log('未登录，无法加载数据');
      return;
    }
    
    // 显示加载中
    if (list.children.length === 0 || list.querySelector('.empty-state')) {
      list.innerHTML = '<li class="loading">正在加载数据...</li>';
    }
    
    // 读取学生数据
    console.log('开始读取students集合...');
    const res = await db.collection('students').get();
    console.log('查询结果:', res);
    
    // 清空列表
    list.innerHTML = '';
    
    if (!res.data || res.data.length === 0) {
      list.innerHTML = '<li class="empty-state">暂无学生数据，请点击上方"添加学生"按钮添加</li>';
      statusMsg.innerHTML = '<span class="warning">暂无学生数据</span>';
      countSpan.textContent = '共 0 个学生';
      console.log('数据库中暂无学生');
      if (practiceChartEl) practiceChartEl.innerHTML = '<div class="log-empty">暂无学生练习数据</div>';
      hideStudentDetail();
      return;
    }

    // 按姓名排序
    const sortedData = res.data.sort((a, b) => {
      return (a.name || '').localeCompare(b.name || '', 'zh-CN');
    });
    
    // 显示学生列表
    console.log(`找到 ${sortedData.length} 个学生`);
    sortedData.forEach((student, index) => {
      const li = document.createElement('li');
      li.style.animationDelay = (index * 0.1) + 's';
      const classLabel = student.class || '未分班';
      li.innerHTML = `
        <span class="student-name">📚 ${student.name}</span>
        <button class="delete-btn" onclick="deleteStudent('${student._id}')">删除</button>
      `;
      li.dataset.name = student.name;
      li.dataset.className = classLabel;
      li.addEventListener('click', () => showStudentDetail(student));
      const deleteBtn = li.querySelector('.delete-btn');
      if (deleteBtn) {
        deleteBtn.addEventListener('click', event => event.stopPropagation());
      }
      list.appendChild(li);
    });

    statusMsg.innerHTML = '<span class="success">✓ 已加载 ' + sortedData.length + ' 个学生</span>';
    countSpan.textContent = '共 ' + sortedData.length + ' 个学生';
    console.log('学生列表加载完成');

    updatePracticeChart(sortedData);

  } catch (error) {
    list.innerHTML = '<li class="empty-state">加载失败: ' + error.message + '</li>';
    statusMsg.innerHTML = '<span class="error">✗ 加载失败: ' + error.message + '</span>';
    countSpan.textContent = '加载失败';
    console.error('加载学生失败:', error);
    
    if (error.code === 'DATABASE_PERMISSION_DENIED') {
      statusMsg.innerHTML += '<br><span class="warning">请检查数据库权限设置</span>';
    }

    if (practiceChartEl) practiceChartEl.innerHTML = '<div class="log-empty">暂无法获取练习数据</div>';
    hideStudentDetail();
  }
}

// 添加学生
window.addStudent = async function() {
  const nameInput = document.getElementById('studentName');
  const name = nameInput.value.trim();
  const statusMsg = document.getElementById('statusMsg');
  
  if (!name) {
    alert('请输入学生姓名');
    nameInput.focus();
    return;
  }
  
  if (!db) {
    alert('系统未初始化，请刷新页面');
    return;
  }
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('未登录，请刷新页面');
      return;
    }
    
    statusMsg.innerHTML = '<span class="info">正在添加学生...</span>';
    console.log('正在添加学生:', name);
    
    // 添加到数据库
    const result = await db.collection('students').add({
      name: name,
      createdAt: new Date().toISOString()
    });
    
    console.log('添加成功，文档ID:', result.id);
    
    // 清空输入框
    nameInput.value = '';
    
    // 显示成功消息
    statusMsg.innerHTML = '<span class="success">✓ 已成功添加学生: ' + name + '</span>';
    
    // 自动重新加载列表
    setTimeout(() => {
      loadStudents();
    }, 500);
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 添加失败: ' + error.message + '</span>';
    console.error('添加学生失败:', error);
    alert('添加失败: ' + error.message);
  }
}

// 删除学生
window.deleteStudent = async function(id) {
  if (!confirm('确定要删除该学生吗？删除后无法恢复。')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  
  if (!db) {
    alert('系统未初始化，请刷新页面');
    return;
  }
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('未登录，请刷新页面');
      return;
    }
    
    statusMsg.innerHTML = '<span class="info">正在删除...</span>';
    console.log('正在删除学生，ID:', id);
    
    // 从数据库删除
    await db.collection('students').doc(id).remove();
    
    console.log('删除成功');
    statusMsg.innerHTML = '<span class="success">✓ 已删除学生</span>';
    
    // 自动重新加载列表
    setTimeout(() => {
      loadStudents();
    }, 500);
    
  } catch (error) {
    statusMsg.innerHTML = '<span class="error">✗ 删除失败: ' + error.message + '</span>';
    console.error('删除学生失败:', error);
    alert('删除失败: ' + error.message);
  }
}

// 内置学生名单
const STUDENT_LISTS = {
  class31: (window.STUDENT_ROSTERS_BY_KEY && Array.isArray(window.STUDENT_ROSTERS_BY_KEY.class31))
    ? window.STUDENT_ROSTERS_BY_KEY.class31.slice()
    : (window.STUDENT_ROSTERS && Array.isArray(window.STUDENT_ROSTERS['31班'])
      ? window.STUDENT_ROSTERS['31班'].slice()
      : []),
  class39: (window.STUDENT_ROSTERS_BY_KEY && Array.isArray(window.STUDENT_ROSTERS_BY_KEY.class39))
    ? window.STUDENT_ROSTERS_BY_KEY.class39.slice()
    : (window.STUDENT_ROSTERS && Array.isArray(window.STUDENT_ROSTERS['39班'])
      ? window.STUDENT_ROSTERS['39班'].slice()
      : [])
};

function renderClassCards() {
  const class31 = STUDENT_LISTS.class31 || [];
  const class39 = STUDENT_LISTS.class39 || [];

  const class31Title = document.getElementById('class31Title');
  if (class31Title) {
    class31Title.textContent = `🏫 31班英语生 (${class31.length}人)`;
  }
  const class31Names = document.getElementById('class31Names');
  if (class31Names) {
    class31Names.textContent = class31.length ? class31.join('、') : '暂无名单';
  }

  const class39Title = document.getElementById('class39Title');
  if (class39Title) {
    class39Title.textContent = `🏫 39班学生 (${class39.length}人)`;
  }
  const class39Names = document.getElementById('class39Names');
  if (class39Names) {
    class39Names.textContent = class39.length ? class39.join('、') : '暂无名单';
  }

  const importAllButton = document.getElementById('importAllButton');
  if (importAllButton) {
    const total = class31.length + class39.length;
    importAllButton.textContent = `📥 导入所有学生 (${total}人)`;
  }
}

// 通用导入学生函数
async function importStudents(studentList, className) {
  const statusMsg = document.getElementById('statusMsg');
  const importStatus = document.getElementById('importStatus');
  
  if (!db) {
    alert('系统未初始化，请刷新页面');
    return;
  }
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('未登录，请刷新页面');
      return;
    }
    
    importStatus.textContent = `正在导入${className}学生...`;
    importStatus.style.color = '#17a2b8';
    statusMsg.innerHTML = `<span class="info">正在导入${className}学生...</span>`;
    
    console.log(`开始导入${className}学生:`, studentList);
    
    // 批量添加到数据库
    const promises = studentList.map(name => 
      db.collection('students').add({
        name: name,
        class: className,
        createdAt: new Date().toISOString()
      })
    );
    
    const results = await Promise.all(promises);
    console.log(`${className}导入成功，添加了`, results.length, '个学生');
    
    // 显示成功消息
    importStatus.textContent = `✅ 成功导入${className} ${studentList.length} 个学生`;
    importStatus.style.color = '#28a745';
    statusMsg.innerHTML = `<span class="success">✓ 已成功导入${className} ${studentList.length} 个学生</span>`;
    
    // 自动重新加载列表
    setTimeout(() => {
      loadStudents();
      // 3秒后清空状态消息
      setTimeout(() => {
        importStatus.textContent = '';
      }, 3000);
    }, 500);
    
  } catch (error) {
    console.error(`${className}导入失败:`, error);
    importStatus.textContent = `❌ ${className}导入失败: ${error.message}`;
    importStatus.style.color = '#dc3545';
    statusMsg.innerHTML = `<span class="error">✗ ${className}导入失败: ${error.message}</span>`;
  }
}

// 导入31班学生
window.importClass31Students = async function() {
  await importStudents(STUDENT_LISTS.class31, '31班');
}

// 导入39班学生
window.importClass39Students = async function() {
  await importStudents(STUDENT_LISTS.class39, '39班');
}

// 导入所有学生
window.importAllStudents = async function() {
  const allStudents = [...STUDENT_LISTS.class31, ...STUDENT_LISTS.class39];
  await importStudents(allStudents, '所有班级');
}

// 清空所有学生
window.clearAllStudents = async function() {
  if (!confirm('确定要清空所有学生吗？此操作不可恢复！')) {
    return;
  }
  
  const statusMsg = document.getElementById('statusMsg');
  const importStatus = document.getElementById('importStatus');
  
  if (!db) {
    alert('系统未初始化，请刷新页面');
    return;
  }
  
  try {
    // 确保已登录
    const loginSuccess = await ensureLogin();
    if (!loginSuccess) {
      alert('未登录，请刷新页面');
      return;
    }
    
    importStatus.textContent = '正在清空所有学生...';
    importStatus.style.color = '#dc3545';
    statusMsg.innerHTML = '<span class="info">正在清空所有学生...</span>';
    
    // 获取所有学生并删除
    const res = await db.collection('students').get();
    if (res.data && res.data.length > 0) {
      const deletePromises = res.data.map(student => 
        db.collection('students').doc(student._id).remove()
      );
      await Promise.all(deletePromises);
    }
    
    console.log('所有学生已清空');
    importStatus.textContent = '✅ 已清空所有学生';
    importStatus.style.color = '#28a745';
    statusMsg.innerHTML = '<span class="success">✓ 已清空所有学生</span>';
    Object.keys(practiceDataStore).forEach(key => delete practiceDataStore[key]);
    
    // 自动重新加载列表
    setTimeout(() => {
      loadStudents();
      // 3秒后清空状态消息
      setTimeout(() => {
        importStatus.textContent = '';
      }, 3000);
    }, 500);
    
  } catch (error) {
    console.error('清空学生失败:', error);
    importStatus.textContent = `❌ 清空失败: ${error.message}`;
    importStatus.style.color = '#dc3545';
    statusMsg.innerHTML = '<span class="error">✗ 清空失败: ' + error.message + '</span>';
  }
}

// 监听输入框回车事件
document.addEventListener('DOMContentLoaded', function() {
  const input = document.getElementById('studentName');
  if (input) {
    input.addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        addStudent();
      }
    });
  }
});
</script>

</body>
</html>
